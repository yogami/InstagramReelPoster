
> instagram-reel-poster@1.0.0 test
> jest

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Memory] Start processJob: 316.42 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-1] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 1: Transcription: 316.63 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-1] TRANSCRIPT: "Transcript text"

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [PersonalClone] Collected voice sample for training

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:127:29)

  console.log
    [job-1] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Start processJob: 317.45 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-1] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 1: Transcription: 317.69 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-1] TRANSCRIPT: "Transcript text"

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [job-1] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Start processJob: 318.17 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-1] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 1: Transcription: 318.45 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-1] TRANSCRIPT: "Transcript text"

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.warn
    [PersonalClone] Failed to collect voice sample: Error: Disk full
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/ReelPersonalCloneIntegration.test.ts:101:93)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      127 |                     console.log('[PersonalClone] Collected voice sample for training');
      128 |                 } catch (err) {
    > 129 |                     console.warn('[PersonalClone] Failed to collect voice sample:', err);
          |                             ^
      130 |                 }
      131 |             }
      132 |

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:129:29)
      at Object.<anonymous> (tests/unit/application/ReelPersonalCloneIntegration.test.ts:104:9)

  console.log
    [job-1] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

(node:26963) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/unit/application/ReelPersonalCloneIntegration.test.ts
  ReelOrchestrator - Personal Clone Integration
    ‚úï should collect voice samples and text samples during processJob when training mode is on (7 ms)
    ‚úì should NOT collect training data when training mode is off (5 ms)
    ‚úì should handle collector errors without failing the job (3 ms)

  ‚óè ReelOrchestrator - Personal Clone Integration ‚Ä∫ should collect voice samples and text samples during processJob when training mode is on

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Segment 1", "commentary"

    Number of calls: 0

      80 |         );
      81 |
    > 82 |         expect(collectTextSpy).toHaveBeenCalledWith('Segment 1', 'commentary');
         |                                ^
      83 |         expect(collectTextSpy).toHaveBeenCalledWith('Segment 2', 'commentary');
      84 |     });
      85 |

      at Object.<anonymous> (tests/unit/application/ReelPersonalCloneIntegration.test.ts:82:32)

FAIL tests/unit/domain/ReelJob.test.ts
  ReelJob
    createReelJob
      ‚úì should create a job with required properties (1 ms)
      ‚úì should use custom duration range when provided
      ‚úì should include mood overrides when provided
      ‚úì should throw error for empty id (3 ms)
      ‚úï should throw error for empty sourceAudioUrl (1 ms)
      ‚úì should throw error for invalid duration range
      ‚úì should throw error for non-positive duration values (1 ms)
    updateJobStatus
      ‚úì should update status and step
      ‚úì should preserve other properties (1 ms)
    failJob
      ‚úì should set status to failed with error message
    completeJob
      ‚úì should set status to completed with final video URL and manifest
    isJobTerminal
      ‚úì should return true for completed jobs
      ‚úì should return true for failed jobs
      ‚úì should return false for non-terminal statuses (2 ms)
    Animated Video Mode Fields
      ‚úì should allow isAnimatedVideoMode flag on ReelJob
      ‚úì should allow animatedVideoUrl field on ReelJob
      ‚úì should default isAnimatedVideoMode to undefined when not set
      ‚úì should preserve isAnimatedVideoMode when updating job status

  ‚óè ReelJob ‚Ä∫ createReelJob ‚Ä∫ should throw error for empty sourceAudioUrl

    expect(received).toThrow(expected)

    Expected substring: "ReelJob sourceAudioUrl cannot be empty"
    Received message:   "ReelJob requires either sourceAudioUrl or transcript"

          169 |
          170 |     if (!hasAudio && !hasTranscript) {
        > 171 |         throw new Error('ReelJob requires either sourceAudioUrl or transcript');
              |               ^
          172 |     }
          173 |
          174 |     const now = new Date();

      at createReelJob (src/domain/entities/ReelJob.ts:171:15)
      at tests/unit/domain/ReelJob.test.ts:68:39
      at Object.<anonymous> (node_modules/expect/build/index.js:1824:9)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:2235:93)
      at Object.<anonymous> (tests/unit/domain/ReelJob.test.ts:68:81)
      at Object.<anonymous> (tests/unit/domain/ReelJob.test.ts:68:81)

(node:26965) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/unit/application/HookAndStructureService.test.ts
  HookAndStructureService
    ‚úì should generate a HookPlan with optimized duration and segment count (3 ms)
    ‚úï should bias towards shorter duration (10-20s) for discovery

  ‚óè HookAndStructureService ‚Ä∫ should bias towards shorter duration (10-20s) for discovery

    expect(received).toBeLessThan(expected)

    Expected: < 60
    Received:   60

      50 |
      51 |         // Default discovery bias should clamp or reduce duration
    > 52 |         expect(result.targetDurationSeconds).toBeLessThan(60);
         |                                              ^
      53 |         expect(result.targetDurationSeconds).toBeGreaterThanOrEqual(10);
      54 |     });
      55 | });

      at Object.<anonymous> (tests/unit/application/HookAndStructureService.test.ts:52:46)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [ReelPlan] Overriding LLM segment count 12 with calculated 10

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:45:21)

  console.log
    [ReelPlan] Targeted 60s with 10 segments.

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:53:17)

  console.log
    [ReelPlan] Overriding LLM segment count 20 with calculated 10

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:45:21)

  console.log
    [ReelPlan] Targeted 100s with 10 segments.

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:53:17)

FAIL tests/unit/DurationRespect.test.ts
  OpenAILLMClient Duration Logic
    ‚úï Should accept LLM-determined duration (e.g. 60s) when requested (3 ms)
    ‚úï Should clamp excessive segment counts to 15

  ‚óè OpenAILLMClient Duration Logic ‚Ä∫ Should accept LLM-determined duration (e.g. 60s) when requested

    expect(received).toBe(expected) // Object.is equality

    Expected: 12
    Received: 10

      37 |
      38 |         expect(plan.targetDurationSeconds).toBe(60);
    > 39 |         expect(plan.segmentCount).toBe(12);
         |                                   ^
      40 |
      41 |         // Verify prompt logic
      42 |         const requestBody = mockedAxios.post.mock.calls[0][1] as any;

      at Object.<anonymous> (tests/unit/DurationRespect.test.ts:39:35)

  ‚óè OpenAILLMClient Duration Logic ‚Ä∫ Should clamp excessive segment counts to 15

    expect(received).toBe(expected) // Object.is equality

    Expected: 15
    Received: 10

      70 |
      71 |         // Assert strictly capped at 15
    > 72 |         expect(plan.segmentCount).toBe(15);
         |                                   ^
      73 |     });
      74 | });
      75 |

      at Object.<anonymous> (tests/unit/DurationRespect.test.ts:72:35)

  console.log
    [Memory] Start processJob: 392.06 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 1: Transcription: 392.09 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] TRANSCRIPT: "Test transcription requiring animation"

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [job-animated-123] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Reel Mode: ANIMATED VIDEO

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:142:25)

  console.log
    [job-animated-123] planning: Planning reel structure...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Planning reel with range: 30s - 60s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:209:21)

  console.log
    [job-animated-123] LLM Initial Plan: target=45s, segments=3

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:289:21)

  console.log
    [Memory] Step 2: Planning: 392.11 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] generating_commentary: Writing commentary...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] synthesizing_voiceover: Creating voiceover...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [job-animated-123] Voiceover generated: duration=45s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:371:25)

  console.log
    [Memory] Steps 3-5: Content & Voiceover: 392.14 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] Caption Debug: jobAfterSegments=true, captionBody=false, hashtags=0, contentMode=direct-message, hasParableScript=false

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:390:21)

  console.warn
    [job-animated-123] Caption NOT generated: contentMode=direct-message, hasParableScript=false, hasCaptionService=false

      430 |                     } else {
      431 |                         // DEBUG: Log why caption was not generated
    > 432 |                         console.warn(`[${jobId}] Caption NOT generated: contentMode=${contentMode}, hasParableScript=${!!parableScriptPlan}, hasCaptionService=${!!this.deps.captionService}`);
          |                                 ^
      433 |                     }
      434 |                 } catch (err) {
      435 |                     console.warn(`[${jobId}] Caption optimization failed:`, err);

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:432:33)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.animatedVideo.test.ts:138:9)

  console.log
    [job-animated-123] selecting_music: Finding background music...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 6: Music: 392.16 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] generating_animated_video: Generating animated video...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Multi-clip mode: 5 clips x 9.0s = 45s total

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:542:33)

  console.log
    [job-animated-123] Generating clip 1/5: 9.0s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:548:37)

  console.log
    [job-animated-123] Persisting clip 1 to Cloudinary...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:567:45)

  console.log
    [job-animated-123] Generating clip 2/5: 9.0s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:548:37)

  console.log
    [job-animated-123] Persisting clip 2 to Cloudinary...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:567:45)

  console.log
    [job-animated-123] Generating clip 3/5: 9.0s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:548:37)

  console.log
    [job-animated-123] Persisting clip 3 to Cloudinary...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:567:45)

  console.log
    [job-animated-123] Generating clip 4/5: 9.0s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:548:37)

  console.log
    [job-animated-123] Persisting clip 4 to Cloudinary...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:567:45)

  console.log
    [job-animated-123] Generating clip 5/5: 9.0s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:548:37)

  console.log
    [job-animated-123] Persisting clip 5 to Cloudinary...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:567:45)

  console.log
    [job-animated-123] Multi-clip complete: 5 videos generated

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:586:33)

  console.log
    [job-animated-123] generating_subtitles: Creating subtitles...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 8: Subtitles: 392.22 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] building_manifest: Preparing render manifest...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] rendering: Rendering final video...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Starting Step 10: Rendering: 392.22 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [Memory] Step 10: Finished Rendering: 392.22 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] uploading: Uploading to permanent storage...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Uploading final video to Cloudinary for permanent storage...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:643:29)

  console.log
    [job-animated-123] Video uploaded successfully: https://cloudinary.com/persisted_anim.mp4

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:650:29)

  console.log
    [job-animated-123] Waiting 5s for final video propagation...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:654:29)

  console.warn
    [DALL-E] Transient error (429), retrying in 2.57s (Attempt 1/5)...

      73 |                         const delay = baseDelay + jitter;
      74 |
    > 75 |                         console.warn(`[DALL-E] Transient error (${status}), retrying in ${delay / 1000}s (Attempt ${attempt + 1}/${this.maxRetries})...`);
         |                                 ^
      76 |                         await this.sleep(delay);
      77 |                         continue;
      78 |                     }

      at OpenAIImageClient.generateImage (src/infrastructure/images/OpenAIImageClient.ts:75:33)
      at Object.<anonymous> (tests/unit/infrastructure/OpenAIImageClient.test.ts:125:13)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

FAIL tests/unit/LLMResilience.test.ts
  LLM Resilience - Segment Normalization
    ‚úï should pass through a plain array
    ‚úï should unwrap an object containing a "segments" array
    ‚úï should wrap a single object into an array
    ‚úï should handle numbered object keys (common LLM failure mode)
    ‚úì should throw for completely invalid data types (20 ms)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should pass through a plain array

    TypeError: client.normalizeSegments is not a function

      13 |             { commentary: 'text 2', imagePrompt: 'prompt 2' }
      14 |         ];
    > 15 |         const result = client.normalizeSegments(input);
         |                               ^
      16 |         expect(result).toHaveLength(2);
      17 |         expect(result[0].commentary).toBe('text 1');
      18 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:15:31)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should unwrap an object containing a "segments" array

    TypeError: client.normalizeSegments is not a function

      25 |             ]
      26 |         };
    > 27 |         const result = client.normalizeSegments(input);
         |                               ^
      28 |         expect(result).toHaveLength(2);
      29 |         expect(result[0].commentary).toBe('text 1');
      30 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:27:31)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should wrap a single object into an array

    TypeError: client.normalizeSegments is not a function

      32 |     it('should wrap a single object into an array', () => {
      33 |         const input = { commentary: 'text 1', imagePrompt: 'prompt 1' };
    > 34 |         const result = client.normalizeSegments(input);
         |                               ^
      35 |         expect(result).toHaveLength(1);
      36 |         expect(result[0].commentary).toBe('text 1');
      37 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:34:31)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should handle numbered object keys (common LLM failure mode)

    TypeError: client.normalizeSegments is not a function

      42 |             "1": { commentary: 'text 2', imagePrompt: 'prompt 2' }
      43 |         };
    > 44 |         const result = client.normalizeSegments(input);
         |                               ^
      45 |         expect(result).toHaveLength(2);
      46 |         expect(result[0].commentary).toBe('text 1');
      47 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:44:31)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

(node:26964) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/unit/infrastructure/LocalLLMClient.test.ts
  LocalLLMClient
    constructor
      ‚úì should throw error if serverUrl is empty (25 ms)
      ‚úì should create client with valid serverUrl
      ‚úì should strip trailing slash from serverUrl
      ‚úì should use default model if not provided
      ‚úì should use custom model if provided (1 ms)
      ‚úì should use default system prompt if not provided
      ‚úì should use custom system prompt if provided (1 ms)
    planReel
      ‚úì should return a valid ReelPlan
      ‚úì should clamp segmentCount to minimum 2
      ‚úì should clamp segmentCount to maximum 15
    generateSegmentContent
      ‚úì should return array of SegmentContent
      ‚úì should normalize array response (1 ms)
    adjustCommentaryLength
      ‚úì should return adjusted segments
    normalizeSegments (via generateSegmentContent)
      ‚úì should unwrap .segments from object
      ‚úì should wrap single object into array
    healthCheck
      ‚úì should return true on successful connection (1 ms)
      ‚úì should return false on connection failure
    error handling
      ‚úï should retry on transient errors (502, 503, 429) (1 ms)
      ‚úï should throw on non-transient errors (2 ms)
      ‚úï should throw on invalid JSON response

  ‚óè LocalLLMClient ‚Ä∫ error handling ‚Ä∫ should retry on transient errors (502, 503, 429)

    thrown: Object {
      "isAxiosError": true,
      "response": Object {
        "data": Object {
          "error": "Bad Gateway",
        },
        "status": 502,
      },
    }

      260 |
      261 |     describe('error handling', () => {
    > 262 |         test('should retry on transient errors (502, 503, 429)', async () => {
          |         ^
      263 |             const client = new LocalLLMClient('http://localhost:11434');
      264 |             const mockPlan = {
      265 |                 targetDurationSeconds: 30,

      at tests/unit/infrastructure/LocalLLMClient.test.ts:262:9
      at tests/unit/infrastructure/LocalLLMClient.test.ts:261:5
      at Object.<anonymous> (tests/unit/infrastructure/LocalLLMClient.test.ts:8:1)

  ‚óè LocalLLMClient ‚Ä∫ error handling ‚Ä∫ should throw on non-transient errors

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"mood": "test", "musicPrompt": "", "musicTags": [], "segmentCount": 6, "summary": "test", "targetDurationSeconds": 30}

      299 |             (axios.isAxiosError as unknown as jest.Mock) = jest.fn().mockReturnValue(true);
      300 |
    > 301 |             await expect(client.planReel('Test', { minDurationSeconds: 10, maxDurationSeconds: 90 }))
          |                   ^
      302 |                 .rejects.toThrow('Local LLM call failed');
      303 |         });
      304 |

      at expect (node_modules/expect/build/index.js:2116:15)
      at Object.<anonymous> (tests/unit/infrastructure/LocalLLMClient.test.ts:301:19)

  ‚óè LocalLLMClient ‚Ä∫ error handling ‚Ä∫ should throw on invalid JSON response

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to parse JSON"

    Received function did not throw

      311 |
      312 |             await expect(client.planReel('Test', { minDurationSeconds: 10, maxDurationSeconds: 90 }))
    > 313 |                 .rejects.toThrow('Failed to parse JSON');
          |                          ^
      314 |         });
      315 |     });
      316 | });

      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/infrastructure/LocalLLMClient.test.ts:313:26)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Kie.ai] Creating task at: https://api.kie.ai/api/v1/jobs/createTask with model: KLING_V2_5_TURBO

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:59:17)

  console.error
    [Kie.ai] API Error (undefined): Unknown error

      85 |             if (data.code !== 200) {
      86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
    > 87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
         |                         ^
      88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
      89 |             }
      90 |

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:87:25)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:43:28)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.error
    [TTS] ‚ùå Primary TTS (Fish Audio) failed. Falling back to OpenAI.

      778 |             result = await this.deps.ttsClient.synthesize(text);
      779 |         } catch (error: any) {
    > 780 |             console.error('[TTS] ‚ùå Primary TTS (Fish Audio) failed. Falling back to OpenAI.');
          |                     ^
      781 |             console.error(`[TTS] Error Details: ${error.message}`);
      782 |             if (error.response) {
      783 |                 console.error(`[TTS] Status: ${error.response.status}`);

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:780:21)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:265:28)

  console.log
    [Integration] Initializing Fish Audio Client with Voice ID: 716594c03801446bb87a964a1c2a5895

      at tests/integration/FishAudioLive.test.ts:20:13

  console.error
    [TTS] Error Details: Primary TTS failed

      779 |         } catch (error: any) {
      780 |             console.error('[TTS] ‚ùå Primary TTS (Fish Audio) failed. Falling back to OpenAI.');
    > 781 |             console.error(`[TTS] Error Details: ${error.message}`);
          |                     ^
      782 |             if (error.response) {
      783 |                 console.error(`[TTS] Status: ${error.response.status}`);
      784 |                 console.error(`[TTS] Data: ${JSON.stringify(error.response.data)}`);

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:781:21)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:265:28)

  console.warn
    [TTS] ‚ö†Ô∏è Using fallback TTS client...

      786 |
      787 |             if (this.deps.fallbackTTSClient) {
    > 788 |                 console.warn('[TTS] ‚ö†Ô∏è Using fallback TTS client...');
          |                         ^
      789 |                 result = await this.deps.fallbackTTSClient.synthesize(text);
      790 |             } else {
      791 |                 throw error;

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:788:25)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:265:28)

  console.log
    [TTS] Applying speed adjustment (0.92x) with pitch 0.9...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:801:29)

  console.log
    [Integration] Sending synthesis request...

      at Object.<anonymous> (tests/integration/FishAudioLive.test.ts:26:17)

  console.warn
    [TTS] ‚ö†Ô∏è Primary TTS speed adjustment failed: Primary TTS failed

      802 |                     result = await this.deps.ttsClient.synthesize(text, { speed, pitch: 0.9 });
      803 |                 } catch (error: any) {
    > 804 |                     console.warn('[TTS] ‚ö†Ô∏è Primary TTS speed adjustment failed:', error.message);
          |                             ^
      805 |
      806 |                     if (this.deps.fallbackTTSClient) {
      807 |                         console.log('[TTS] Trying fallback client for speed adjustment with pitch 0.9...');

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:804:29)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:265:28)

  console.log
    [TTS] Trying fallback client for speed adjustment with pitch 0.9...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:807:33)

  console.log
    [Fish Audio] Synthesizing with voice ID: 716594c03801446bb87a964a1c2a5895

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    Generating images for 2 segments...

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:862:17)

  console.log
    [job-123] generating_images: Creating visual 1 of 2...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.warn
    Primary image client failed for segment 0, falling back to secondary client: TypeError: this.deps.jobManager.updateStatus is not a function
        at ReelOrchestrator.updateJobStatus (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:956:30)
        at ReelOrchestrator.generateImages (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:880:36)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/ReelOrchestrator.test.ts:286:34)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      882 |                         finalImageUrl = imageUrl;
      883 |                     } catch (primaryError) {
    > 884 |                         console.warn(`Primary image client failed for segment ${index}, falling back to secondary client:`, primaryError);
          |                                 ^
      885 |                         const { imageUrl } = await this.deps.fallbackImageClient.generateImage(segment.imagePrompt);
      886 |                         finalImageUrl = imageUrl;
      887 |                     }

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:884:33)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:286:34)

  console.log
    [job-123] generating_images: Creating visual 2 of 2...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.warn
    Primary image client failed for segment 1, falling back to secondary client: TypeError: this.deps.jobManager.updateStatus is not a function
        at ReelOrchestrator.updateJobStatus (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:956:30)
        at ReelOrchestrator.generateImages (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:880:36)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/ReelOrchestrator.test.ts:286:28)

      882 |                         finalImageUrl = imageUrl;
      883 |                     } catch (primaryError) {
    > 884 |                         console.warn(`Primary image client failed for segment ${index}, falling back to secondary client:`, primaryError);
          |                                 ^
      885 |                         const { imageUrl } = await this.deps.fallbackImageClient.generateImage(segment.imagePrompt);
      886 |                         finalImageUrl = imageUrl;
      887 |                     }

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:884:33)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:286:28)

  console.log
    Waiting 2s for asset propagation...

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:919:21)

  console.log
    [Kie.ai] Creating task at: https://api.kie.ai/api/v1/jobs/createTask with model: KLING_V2_5_TURBO

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:59:17)

  console.log
    [Kie.ai] Creating task at: https://api.kie.ai/api/v1/jobs/createTask with model: KLING_V2_5_TURBO

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:59:17)

  console.error
    [Kie.ai] API Error (undefined): Unknown error

      85 |             if (data.code !== 200) {
      86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
    > 87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
         |                         ^
      88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
      89 |             }
      90 |

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:87:25)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:80:13)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [Kie.ai] Creating task at: https://api.kie.ai/api/v1/jobs/createTask with model: KLING_V2_5_TURBO

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:59:17)

  console.error
    [Kie.ai] API Error (undefined): Unknown error

      85 |             if (data.code !== 200) {
      86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
    > 87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
         |                         ^
      88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
      89 |             }
      90 |

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:87:25)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:90:13)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

(node:26966) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
  console.log
    Loaded 8 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

FAIL tests/unit/infrastructure/KieVideoClient.test.ts
  KieVideoClient
    generateAnimatedVideo
      ‚úï should create a task and poll until success (35 ms)
      ‚úì should throw error if task creation fails (1 ms)
      ‚úï should throw error if production fails (3 ms)
      ‚úï should timeout if max attempts reached (7 ms)

  ‚óè KieVideoClient ‚Ä∫ generateAnimatedVideo ‚Ä∫ should create a task and poll until success

    Kie.ai API error undefined: Unknown error

      86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
      87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
    > 88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
         |                       ^
      89 |             }
      90 |
      91 |             const jobId = data.data?.taskId || data.taskId || data.id;

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:88:23)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:43:28)

  ‚óè KieVideoClient ‚Ä∫ generateAnimatedVideo ‚Ä∫ should throw error if production fails

    expect(received).rejects.toThrow(expected)

    Expected substring: "Kie.ai video generation failed: Content policy violation"
    Received message:   "Kie.ai API error undefined: Unknown error"

          86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
          87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
        > 88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
             |                       ^
          89 |             }
          90 |
          91 |             const jobId = data.data?.taskId || data.taskId || data.id;

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:88:23)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:80:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:83:25)

  ‚óè KieVideoClient ‚Ä∫ generateAnimatedVideo ‚Ä∫ should timeout if max attempts reached

    expect(received).rejects.toThrow(expected)

    Expected pattern: /timed out/
    Received message: "Kie.ai API error undefined: Unknown error"

          86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
          87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
        > 88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
             |                       ^
          89 |             }
          90 |
          91 |             const jobId = data.data?.taskId || data.taskId || data.id;

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:88:23)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:90:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:93:25)

  console.log
    [Memory] Start processJob: 343.28 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [job_0ae77ddf] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Whisper] Downloading source: https://example.com/voice-note.mp3

      at OpenAITranscriptionClient.transcribe (src/infrastructure/transcription/OpenAITranscriptionClient.ts:46:21)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [Whisper] Downloaded 0.0MB

      at OpenAITranscriptionClient.transcribe (src/infrastructure/transcription/OpenAITranscriptionClient.ts:62:21)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Whisper] Sending to OpenAI...

      at OpenAITranscriptionClient.transcribe (src/infrastructure/transcription/OpenAITranscriptionClient.ts:96:21)

  console.log
    [Test] Submitting render to Shotstack...

      at Object.<anonymous> (tests/integration/ShotstackPayload.test.ts:37:21)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [Shotstack] Request payload size: 0.82 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Memory] Step 1: Transcription: 358.14 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job_0ae77ddf] TRANSCRIPT: "Today I want to talk about the importance of mindfulness in our daily lives. When we practice being present in the moment, we reduce stress and anxiety. It helps us connect better with ourselves and others. Even just five minutes of meditation can make a huge difference in how we feel throughout the day."

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [TrainingData] Collected voice sample: voice_1766745600868 (30s)

      at TrainingDataCollector.collectVoiceSample (src/infrastructure/training/TrainingDataCollector.ts:84:17)

  console.log
    [PersonalClone] Collected voice sample for training

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:127:29)

  console.log
    [job_0ae77ddf] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice-id

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

  console.log
    [Memory] Start processJob: 312.11 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [test-job] TRANSCRIPT: "mock transcript"

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [TrainingData] Collected voice sample: voice_1766745600878 (30s)

      at TrainingDataCollector.collectVoiceSample (src/infrastructure/training/TrainingDataCollector.ts:84:17)

  console.log
    [PersonalClone] Collected voice sample for training

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:127:29)

  console.log
    [test-job] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

(node:26959) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:26962) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/unit/infrastructure/FishAudioTTSClient.test.ts
  FishAudioTTSClient
    Constructor validation
      ‚úì should throw error when API key is missing (18 ms)
      ‚úì should throw error when voice ID is missing
      ‚úì should create client with valid credentials (2 ms)
    synthesize() - Input validation
      ‚úì should throw error for empty text (1 ms)
      ‚úì should throw error for whitespace-only text
    synthesize() - JSON response format
      ‚úì should handle JSON response with audio_url (23 ms)
      ‚úì should handle JSON response with fallback duration estimation (9 ms)
      ‚úì should throw error when JSON response has no audio URL (7 ms)
    synthesize() - Binary response format
      ‚úì should handle binary audio data response (8 ms)
    synthesize() - Speed adjustment
      ‚úì should apply speed adjustment to duration estimation (6 ms)
    synthesize() - Error handling
      ‚úì should throw descriptive error on API failure (35 ms)
      ‚úì should handle network timeout (12 ms)
      ‚úì should handle 429 rate limit (42 ms)

FAIL tests/unit/SegmentConsistency.test.ts
  ReelOrchestrator Segment Consistency
    ‚úï Should FAIL if LLM returns fewer segments than planned (29 ms)

  ‚óè ReelOrchestrator Segment Consistency ‚Ä∫ Should FAIL if LLM returns fewer segments than planned

    expect(received).rejects.toThrow(expected)

    Expected pattern: /Segment count mismatch/
    Received message: "this.deps.llmClient.detectReelMode is not a function"

          139 |             if (job.isAnimatedVideoMode === undefined) {
          140 |                 await this.updateJobStatus(jobId, 'detecting_intent', 'Analyzing request for animation...');
        > 141 |                 detectionResult = await this.deps.llmClient.detectReelMode(transcript);
              |                                                             ^
          142 |                 console.log(`[${jobId}] Reel Mode: ${detectionResult.isAnimatedMode ? 'ANIMATED VIDEO' : 'IMAGES'}`);
          143 |
          144 |                 await this.deps.jobManager.updateJob(jobId, {

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:141:61)
      at Object.<anonymous> (tests/unit/SegmentConsistency.test.ts:70:9)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/SegmentConsistency.test.ts:70:62)

  console.warn
    [LLM] Reel mode detection failed, defaulting to image mode: Error: OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "1198",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are an intent detection assistant. Analyze user input and return structured JSON responses. Be precise and factual.\"},{\"role\":\"user\",\"content\":\"Analyze the transcript and determine if the user wants an ANIMATED VIDEO REEL (story-driven, scene-by-scene) or a standard IMAGE-BASED REEL.\\n\\nTranscript: \\\"Today I want to talk about the importance of mindfulness in our daily lives. When we practice being present in the moment, we reduce stress and anxiety. It helps us connect better with ourselves and others. Even just five minutes of meditation can make a huge difference in how we feel throughout the day.\\\"\\n\\nA reel should be ANIMATED if the user:\\n- Describes a \\\"story,\\\" \\\"tale,\\\" or \\\"narrative\\\"\\n- Mentions \\\"monks,\\\" \\\"warriors,\\\" \\\"kings,\\\" or specific characters in a sequence\\n- Asks for \\\"animation\\\" or \\\"movement\\\" between scenes\\n- Describes a parable or teaching story\\n\\nRespond with a JSON object:\\n{\\n  \\\"isAnimatedMode\\\": true/false,\\n  \\\"storyline\\\": \\\"Short description of the story if animated, else null\\\",\\n  \\\"reason\\\": \\\"Brief explanation\\\"\\n}\"}],\"temperature\":0.3,\"response_format\":{\"type\":\"json_object\"}}"
    }
        at OpenAIService.handleError (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:96:15)
        at OpenAIService.chatCompletion (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:39:32)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at OpenAILLMClient.detectReelMode (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAILLMClient.ts:60:30)
        at ReelOrchestrator.processJob (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:141:35)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/e2e/reel-generation.test.ts:108:24)

      69 |             };
      70 |         } catch (error) {
    > 71 |             console.warn('[LLM] Reel mode detection failed, defaulting to image mode:', error);
         |                     ^
      72 |             return {
      73 |                 isAnimatedMode: false,
      74 |                 reason: 'Detection failed, defaulting to image-based reel',

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:71:21)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:141:35)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  console.log
    [job_0ae77ddf] Reel Mode: IMAGES

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:142:25)

  console.warn
    [ParableGenerator] Content mode detection failed, defaulting to direct-message: Error: OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "1370",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are an intent detection assistant. Analyze user input and return structured JSON responses. Be precise and factual.\"},{\"role\":\"user\",\"content\":\"Analyze this voice note transcript and determine if it's asking for a PARABLE/STORY or DIRECT COMMENTARY.\\n\\nTranscript:\\n\\\"\\\"\\\"\\nToday I want to talk about the importance of mindfulness in our daily lives. When we practice being present in the moment, we reduce stress and anxiety. It helps us connect better with ourselves and others. Even just five minutes of meditation can make a huge difference in how we feel throughout the day.\\n\\\"\\\"\\\"\\n\\nPARABLE KEYWORDS (return \\\"parable\\\" if any are present):\\n- \\\"story\\\", \\\"tale\\\", \\\"parable\\\", \\\"once upon\\\"\\n- \\\"monk\\\", \\\"sage\\\", \\\"saint\\\", \\\"warrior\\\", \\\"king\\\", \\\"farmer\\\"\\n- \\\"ancient\\\", \\\"old tale\\\", \\\"legend\\\", \\\"fable\\\"\\n- References to Zen, Sufi, Buddhist, Hindu, or folklore stories\\n- Describing characters, scenes, or narratives\\n\\nDIRECT-MESSAGE (default - return this if no story indicators):\\n- Commentary, rant, thoughts, opinions\\n- Discussing concepts without narrative framing\\n- Educational or explanatory content\\n\\nRespond with JSON:\\n{\\n  \\\"contentMode\\\": \\\"parable\\\" or \\\"direct-message\\\",\\n  \\\"reason\\\": \\\"brief explanation\\\"\\n}\"}],\"temperature\":0.3,\"response_format\":{\"type\":\"json_object\"}}"
    }
        at OpenAIService.handleError (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:96:15)
        at OpenAIService.chatCompletion (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:39:32)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at ParableGenerator.detectContentMode (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/ParableGenerator.ts:67:30)
        at ReelOrchestrator.processJob (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:193:51)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/e2e/reel-generation.test.ts:108:24)

      74 |             };
      75 |         } catch (error) {
    > 76 |             console.warn('[ParableGenerator] Content mode detection failed, defaulting to direct-message:', error);
         |                     ^
      77 |             return {
      78 |                 contentMode: 'direct-message',
      79 |                 reason: 'Detection failed, defaulting to direct-message'

      at ParableGenerator.detectContentMode (src/infrastructure/llm/ParableGenerator.ts:76:21)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:193:51)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  console.log
    [job_0ae77ddf] Content Mode: DIRECT-MESSAGE (detected: Detection failed, defaulting to direct-message)

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:195:33)

  console.log
    [job_0ae77ddf] planning: Planning reel structure...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job_0ae77ddf] Planning reel with range: 10s - 15s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:209:21)

  console.log
    [ReelPlan] Targeted 30s with 3 segments.

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:53:17)

  console.log
    [job_0ae77ddf] LLM Initial Plan: target=30s, segments=3

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:289:21)

  console.log
    [Memory] Step 2: Planning: 349.33 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job_0ae77ddf] generating_commentary: Writing commentary...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [StandardReel] Step 1: Generating commentary for 3 segments (Target: 20 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    [StandardReel] Starting iterative generation for 3 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.warn
    [StandardReel] Segment 1: Invalid response, using fallback.

      136 |
      137 |                 if (!parsed || !parsed.commentary) {
    > 138 |                     console.warn(`[StandardReel] Segment ${i}: Invalid response, using fallback.`);
          |                             ^
      139 |                     results.push({ commentary: `Segment ${i} content.` });
      140 |                 } else {
      141 |                     results.push({ commentary: parsed.commentary });

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:138:29)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:75:30)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  console.warn
    [StandardReel] Segment 2: Invalid response, using fallback.

      136 |
      137 |                 if (!parsed || !parsed.commentary) {
    > 138 |                     console.warn(`[StandardReel] Segment ${i}: Invalid response, using fallback.`);
          |                             ^
      139 |                     results.push({ commentary: `Segment ${i} content.` });
      140 |                 } else {
      141 |                     results.push({ commentary: parsed.commentary });

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:138:29)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:75:30)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  console.warn
    [StandardReel] Segment 3: Invalid response, using fallback.

      136 |
      137 |                 if (!parsed || !parsed.commentary) {
    > 138 |                     console.warn(`[StandardReel] Segment ${i}: Invalid response, using fallback.`);
          |                             ^
      139 |                     results.push({ commentary: `Segment ${i} content.` });
      140 |                 } else {
      141 |                     results.push({ commentary: parsed.commentary });

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:138:29)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:75:30)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  console.log
    [StandardReel] Iterative generation complete: 3 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 3 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

  console.warn
    [OpenAIService] Transient error (429: Rate limit exceeded...), retrying in 2.635s (Attempt 1/5)...

      89 |             const delay = baseDelay + jitter;
      90 |
    > 91 |             console.warn(`[OpenAIService] Transient error (${status}: ${message.substring(0, 50)}...), retrying in ${delay / 1000}s (Attempt ${attempt + 1}/${maxRetries})...`);
         |                     ^
      92 |             await new Promise(resolve => setTimeout(resolve, delay));
      93 |             return true;
      94 |         }

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:91:21)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:36:26)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:104:13)

  console.log
    Loaded 9 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [Memory] Start processJob: 345.39 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job_383b0526] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Whisper] Downloading source: https://example.com/voice-note.mp3

      at OpenAITranscriptionClient.transcribe (src/infrastructure/transcription/OpenAITranscriptionClient.ts:46:21)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Whisper] Downloaded 0.0MB

      at OpenAITranscriptionClient.transcribe (src/infrastructure/transcription/OpenAITranscriptionClient.ts:62:21)

  console.log
    [Whisper] Sending to OpenAI...

      at OpenAITranscriptionClient.transcribe (src/infrastructure/transcription/OpenAITranscriptionClient.ts:96:21)

  console.log
    [Memory] Step 1: Transcription: 342.2 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job_383b0526] TRANSCRIPT: "Today I want to talk about the importance of mindfulness in our daily lives. When we practice being present in the moment, we reduce stress and anxiety. It helps us connect better with ourselves and others. Even just five minutes of meditation can make a huge difference in how we feel throughout the day."

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [TrainingData] Collected voice sample: voice_1766745600985 (30s)

      at TrainingDataCollector.collectVoiceSample (src/infrastructure/training/TrainingDataCollector.ts:84:17)

  console.log
    [PersonalClone] Collected voice sample for training

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:127:29)

  console.log
    [job_383b0526] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.warn
    [LLM] Reel mode detection failed, defaulting to image mode: Error: OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "1198",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are an intent detection assistant. Analyze user input and return structured JSON responses. Be precise and factual.\"},{\"role\":\"user\",\"content\":\"Analyze the transcript and determine if the user wants an ANIMATED VIDEO REEL (story-driven, scene-by-scene) or a standard IMAGE-BASED REEL.\\n\\nTranscript: \\\"Today I want to talk about the importance of mindfulness in our daily lives. When we practice being present in the moment, we reduce stress and anxiety. It helps us connect better with ourselves and others. Even just five minutes of meditation can make a huge difference in how we feel throughout the day.\\\"\\n\\nA reel should be ANIMATED if the user:\\n- Describes a \\\"story,\\\" \\\"tale,\\\" or \\\"narrative\\\"\\n- Mentions \\\"monks,\\\" \\\"warriors,\\\" \\\"kings,\\\" or specific characters in a sequence\\n- Asks for \\\"animation\\\" or \\\"movement\\\" between scenes\\n- Describes a parable or teaching story\\n\\nRespond with a JSON object:\\n{\\n  \\\"isAnimatedMode\\\": true/false,\\n  \\\"storyline\\\": \\\"Short description of the story if animated, else null\\\",\\n  \\\"reason\\\": \\\"Brief explanation\\\"\\n}\"}],\"temperature\":0.3,\"response_format\":{\"type\":\"json_object\"}}"
    }
        at OpenAIService.handleError (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:96:15)
        at OpenAIService.chatCompletion (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:39:32)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at OpenAILLMClient.detectReelMode (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAILLMClient.ts:60:30)
        at ReelOrchestrator.processJob (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:141:35)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/e2e/reel-generation.test.ts:134:24)

      69 |             };
      70 |         } catch (error) {
    > 71 |             console.warn('[LLM] Reel mode detection failed, defaulting to image mode:', error);
         |                     ^
      72 |             return {
      73 |                 isAnimatedMode: false,
      74 |                 reason: 'Detection failed, defaulting to image-based reel',

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:71:21)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:141:35)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:134:24)

  console.log
    [job_383b0526] Reel Mode: IMAGES

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:142:25)

  console.warn
    [ParableGenerator] Content mode detection failed, defaulting to direct-message: Error: OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "1370",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are an intent detection assistant. Analyze user input and return structured JSON responses. Be precise and factual.\"},{\"role\":\"user\",\"content\":\"Analyze this voice note transcript and determine if it's asking for a PARABLE/STORY or DIRECT COMMENTARY.\\n\\nTranscript:\\n\\\"\\\"\\\"\\nToday I want to talk about the importance of mindfulness in our daily lives. When we practice being present in the moment, we reduce stress and anxiety. It helps us connect better with ourselves and others. Even just five minutes of meditation can make a huge difference in how we feel throughout the day.\\n\\\"\\\"\\\"\\n\\nPARABLE KEYWORDS (return \\\"parable\\\" if any are present):\\n- \\\"story\\\", \\\"tale\\\", \\\"parable\\\", \\\"once upon\\\"\\n- \\\"monk\\\", \\\"sage\\\", \\\"saint\\\", \\\"warrior\\\", \\\"king\\\", \\\"farmer\\\"\\n- \\\"ancient\\\", \\\"old tale\\\", \\\"legend\\\", \\\"fable\\\"\\n- References to Zen, Sufi, Buddhist, Hindu, or folklore stories\\n- Describing characters, scenes, or narratives\\n\\nDIRECT-MESSAGE (default - return this if no story indicators):\\n- Commentary, rant, thoughts, opinions\\n- Discussing concepts without narrative framing\\n- Educational or explanatory content\\n\\nRespond with JSON:\\n{\\n  \\\"contentMode\\\": \\\"parable\\\" or \\\"direct-message\\\",\\n  \\\"reason\\\": \\\"brief explanation\\\"\\n}\"}],\"temperature\":0.3,\"response_format\":{\"type\":\"json_object\"}}"
    }
        at OpenAIService.handleError (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:96:15)
        at OpenAIService.chatCompletion (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:39:32)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at ParableGenerator.detectContentMode (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/ParableGenerator.ts:67:30)
        at ReelOrchestrator.processJob (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:193:51)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/e2e/reel-generation.test.ts:134:24)

      74 |             };
      75 |         } catch (error) {
    > 76 |             console.warn('[ParableGenerator] Content mode detection failed, defaulting to direct-message:', error);
         |                     ^
      77 |             return {
      78 |                 contentMode: 'direct-message',
      79 |                 reason: 'Detection failed, defaulting to direct-message'

      at ParableGenerator.detectContentMode (src/infrastructure/llm/ParableGenerator.ts:76:21)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:193:51)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:134:24)

  console.log
    [job_383b0526] Content Mode: DIRECT-MESSAGE (detected: Detection failed, defaulting to direct-message)

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:195:33)

  console.log
    [job_383b0526] planning: Planning reel structure...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job_383b0526] Planning reel with range: 5s - 10s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:209:21)

  console.log
    [ReelPlan] Overriding LLM segment count 3 with calculated 2

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:45:21)

  console.log
    [ReelPlan] Targeted 30s with 2 segments.

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:53:17)

  console.log
    [job_383b0526] LLM Initial Plan: target=30s, segments=2

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:289:21)

  console.log
    [Memory] Step 2: Planning: 338.52 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job_383b0526] generating_commentary: Writing commentary...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [StandardReel] Step 1: Generating commentary for 2 segments (Target: 30 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    [StandardReel] Starting iterative generation for 2 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.warn
    [StandardReel] Segment 1: Invalid response, using fallback.

      136 |
      137 |                 if (!parsed || !parsed.commentary) {
    > 138 |                     console.warn(`[StandardReel] Segment ${i}: Invalid response, using fallback.`);
          |                             ^
      139 |                     results.push({ commentary: `Segment ${i} content.` });
      140 |                 } else {
      141 |                     results.push({ commentary: parsed.commentary });

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:138:29)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:75:30)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:134:24)

  console.warn
    [StandardReel] Segment 2: Invalid response, using fallback.

      136 |
      137 |                 if (!parsed || !parsed.commentary) {
    > 138 |                     console.warn(`[StandardReel] Segment ${i}: Invalid response, using fallback.`);
          |                             ^
      139 |                     results.push({ commentary: `Segment ${i} content.` });
      140 |                 } else {
      141 |                     results.push({ commentary: parsed.commentary });

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:138:29)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:75:30)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:134:24)

  console.log
    [StandardReel] Iterative generation complete: 2 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 2 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

(node:26960) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/e2e/reel-generation.test.ts
  ReelOrchestrator E2E
    ‚úï should generate reel end-to-end successfully (169 ms)
    ‚úï should fall back to DALL-E when OpenRouter fails with text response (53 ms)

  ‚óè ReelOrchestrator E2E ‚Ä∫ should generate reel end-to-end successfully

    OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "2705",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are the creative mind behind \\\"Challenging View,\\\" an Instagram channel that uses spiritual psychology and caustic ancient wisdom to expose modern self-deception.\\n\\nVOICE AND PERSONALITY:\\n- Tone: Direct, grounded, spiritually perspicacious, unapologetic.\\n- Background: A mix of Indian cultural roots and Californian psychological directness.\\n- Philosophy: Truth is often uncomfortable; your job is to deliver it with surgical precision.\\n- Style: Pattern-breaking. You stop the scroll by saying what others are too polite or too deluded to say.\\n\\nWRITING GUIDELINES:\\n1. NO FLUFF: Avoid introductory filler (\\\"In this video,\\\" \\\"So,\\\" \\\"Hey guys\\\"). Start with the punch.\\n2. CONSTRUCTIVE CAUSTICITY: Be sharp, but the goal is always deeper self-awareness, not just being mean.\\n3. GROUNDED SPIRITUALITY: Use terms like \\\"shadow work,\\\" \\\"projection,\\\" \\\"bypass,\\\" and \\\"ego mechanics.\\\" Avoid \\\"love and light\\\" or generic wellness clich√©s.\\n4. MICRO-DOSE INSIGHT: Every sentence must earned its place. If it doesn't challenge or reveal, cut it.\\n5. CULTURAL FUSION: Subtly weave in Vedantic or Zen concepts without being \\\"yoga-teacher-y.\\\"\\n\\nIMAGE STYLE:\\n- Aesthetic: Muted, cinematic, grounded, slightly dark but clear.\\n- Preference for high-contrast, moody lighting.\\n- Focus on symbolic objects or minimalist environments that mirror the psychological state.\"},{\"role\":\"user\",\"content\":\"Generate visual prompts for an Instagram Reel based on the provided commentary.\\n\\nCONCEPT SUMMARY: \\\"A mindful exploration of presence and meditation\\\"\\nOVERALL MOOD: \\\"peaceful and contemplative\\\"\\nSEGMENT COUNT: 3\\n\\nINPUT COMMENTARIES:\\nSegment 1: \\\"Segment 1 content.\\\"\\nSegment 2: \\\"Segment 2 content.\\\"\\nSegment 3: \\\"Segment 3 content.\\\"\\n\\nTASK:\\nFor each commentary segment, generate:\\n1. imagePrompt: Detailed Midjourney-style prompt illustrating the commentary.\\n2. caption: Short 3-5 word text overlay.\\n3. continuityTags: Object with visual consistency trackers.\\n\\nSCENE CONTINUITY RULES:\\n- Index 0: Establish anchor (location, lighting, style).\\n- Index 1+: \\\"Continuation of previous scene:\\\" + reference previous tags.\\n- IMAGE POLICY: If people/couples are depicted, they MUST be a Heterosexual couple (to maintain brand consistency).\\n\\nRespond as JSON array (SAME ORDER as input):\\n[\\n  {\\n    \\\"imagePrompt\\\": \\\"...\\\",\\n    \\\"caption\\\": \\\"...\\\",\\n    \\\"continuityTags\\\": {\\n      \\\"location\\\": \\\"...\\\",\\n      \\\"timeOfDay\\\": \\\"...\\\",\\n      \\\"dominantColor\\\": \\\"...\\\",\\n      \\\"heroProp\\\": \\\"...\\\",\\n      \\\"wardrobeDetail\\\": \\\"...\\\"\\n    }\\n  },\\n  ...\\n]\"}],\"temperature\":0.7,\"response_format\":{\"type\":\"json_object\"}}"
    }

      94 |         }
      95 |
    > 96 |         throw new Error(`OpenAI call failed: ${message}`);
         |               ^
      97 |     }
      98 |
      99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.generateVisuals (src/infrastructure/llm/StandardReelGenerator.ts:211:26)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:80:25)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  ‚óè ReelOrchestrator E2E ‚Ä∫ should fall back to DALL-E when OpenRouter fails with text response

    OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "2670",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are the creative mind behind \\\"Challenging View,\\\" an Instagram channel that uses spiritual psychology and caustic ancient wisdom to expose modern self-deception.\\n\\nVOICE AND PERSONALITY:\\n- Tone: Direct, grounded, spiritually perspicacious, unapologetic.\\n- Background: A mix of Indian cultural roots and Californian psychological directness.\\n- Philosophy: Truth is often uncomfortable; your job is to deliver it with surgical precision.\\n- Style: Pattern-breaking. You stop the scroll by saying what others are too polite or too deluded to say.\\n\\nWRITING GUIDELINES:\\n1. NO FLUFF: Avoid introductory filler (\\\"In this video,\\\" \\\"So,\\\" \\\"Hey guys\\\"). Start with the punch.\\n2. CONSTRUCTIVE CAUSTICITY: Be sharp, but the goal is always deeper self-awareness, not just being mean.\\n3. GROUNDED SPIRITUALITY: Use terms like \\\"shadow work,\\\" \\\"projection,\\\" \\\"bypass,\\\" and \\\"ego mechanics.\\\" Avoid \\\"love and light\\\" or generic wellness clich√©s.\\n4. MICRO-DOSE INSIGHT: Every sentence must earned its place. If it doesn't challenge or reveal, cut it.\\n5. CULTURAL FUSION: Subtly weave in Vedantic or Zen concepts without being \\\"yoga-teacher-y.\\\"\\n\\nIMAGE STYLE:\\n- Aesthetic: Muted, cinematic, grounded, slightly dark but clear.\\n- Preference for high-contrast, moody lighting.\\n- Focus on symbolic objects or minimalist environments that mirror the psychological state.\"},{\"role\":\"user\",\"content\":\"Generate visual prompts for an Instagram Reel based on the provided commentary.\\n\\nCONCEPT SUMMARY: \\\"A mindful exploration of presence and meditation\\\"\\nOVERALL MOOD: \\\"peaceful and contemplative\\\"\\nSEGMENT COUNT: 2\\n\\nINPUT COMMENTARIES:\\nSegment 1: \\\"Segment 1 content.\\\"\\nSegment 2: \\\"Segment 2 content.\\\"\\n\\nTASK:\\nFor each commentary segment, generate:\\n1. imagePrompt: Detailed Midjourney-style prompt illustrating the commentary.\\n2. caption: Short 3-5 word text overlay.\\n3. continuityTags: Object with visual consistency trackers.\\n\\nSCENE CONTINUITY RULES:\\n- Index 0: Establish anchor (location, lighting, style).\\n- Index 1+: \\\"Continuation of previous scene:\\\" + reference previous tags.\\n- IMAGE POLICY: If people/couples are depicted, they MUST be a Heterosexual couple (to maintain brand consistency).\\n\\nRespond as JSON array (SAME ORDER as input):\\n[\\n  {\\n    \\\"imagePrompt\\\": \\\"...\\\",\\n    \\\"caption\\\": \\\"...\\\",\\n    \\\"continuityTags\\\": {\\n      \\\"location\\\": \\\"...\\\",\\n      \\\"timeOfDay\\\": \\\"...\\\",\\n      \\\"dominantColor\\\": \\\"...\\\",\\n      \\\"heroProp\\\": \\\"...\\\",\\n      \\\"wardrobeDetail\\\": \\\"...\\\"\\n    }\\n  },\\n  ...\\n]\"}],\"temperature\":0.7,\"response_format\":{\"type\":\"json_object\"}}"
    }

      94 |         }
      95 |
    > 96 |         throw new Error(`OpenAI call failed: ${message}`);
         |               ^
      97 |     }
      98 |
      99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.generateVisuals (src/infrastructure/llm/StandardReelGenerator.ts:211:26)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:80:25)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:134:24)

  console.log
    [Shotstack] Render started: render-123

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [Shotstack] Render render-123 status: queued

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [StandardReel] Step 1: Generating commentary for 3 segments (Target: 9 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    [StandardReel] Starting iterative generation for 3 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.log
    [StandardReel] Generated segment 1/3: "Commentary 1..."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Generated segment 2/3: "Commentary 2..."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Generated segment 3/3: "Commentary 3..."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Iterative generation complete: 3 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 3 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [StandardReel] Step 1: Generating commentary for 2 segments (Target: 9 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    [StandardReel] Starting iterative generation for 2 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.log
    [StandardReel] Generated segment 1/2: "Test 1..."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Generated segment 2/2: "Test 2..."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Iterative generation complete: 2 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 2 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

  console.log
    [StandardReel] Step 1: Generating commentary for 1 segments (Target: 9 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    [StandardReel] Starting iterative generation for 1 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.log
    [StandardReel] Generated segment 1/1: "Notice the warm amber glow on this peaceful deck...."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Iterative generation complete: 1 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 1 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.log
    [Shotstack] Request payload size: 0.81 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Render started: render-fail

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [Shotstack] Render render-fail status: failed

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [ReelPlan] Overriding LLM segment count 5 with calculated 3

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:45:21)

  console.log
    [ReelPlan] Targeted 12s with 3 segments.

      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:53:17)

PASS tests/integration/api-pipeline.test.ts
  Integration: LLM Segment Count Invariants
    ‚úì should return EXACTLY N segments when N is requested (26 ms)
    ‚úì should NOT return wrapped object like {segments: [...]} (13 ms)
    ‚úì should generate segments with commentary referencing visual elements (8 ms)
  Integration: OpenRouter Context Size
    ‚úì should extract compact context (~30-40 words) from previous prompt
    ‚úì should maintain linear token growth (not exponential) (12 ms)
    ‚úì should reset sequence between jobs
  Integration: Music Fallback Behavior
    ‚úì should use catalog when track matches (1 ms)
    ‚úì should fallback to Kie.ai when catalog empty (1 ms)
    ‚úì should prefer external catalog over internal
  Integration: Shotstack Render + Polling
    ‚úì should handle render failure gracefully (10 ms)
    ‚óã skipped should submit render and poll until done
  Integration: Segment Count in Plan
    ‚úì should calculate segment count mathematically and enforce it (4 ms)

  console.log
    [Shotstack] Render render-123 status: rendering

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    ‚úÖ Cloudinary storage configured

      at createDependencies (src/presentation/app.ts:99:17)

  console.log
    üé• Using Shotstack Video Renderer (Cloud)

      at createDependencies (src/presentation/app.ts:161:17)

  console.log
    Loaded 10 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [LLM] Reel mode detection: ANIMATED - User explicitly mentioned animated video

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:63:21)

  console.log
    üì° Callback configured: Header=yami-instgram-carousel-api-key, Token=maske...

      at createDependencies (src/presentation/app.ts:230:13)

  console.log
    [LLM] Reel mode detection: ANIMATED - User mentioned animation

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:63:21)

  console.log
    [LLM] Reel mode detection: ANIMATED - User wants moving visuals

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:63:21)

  console.log
    [LLM] Reel mode detection: IMAGES - No animation keywords detected

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:63:21)

  console.log
    [LLM] Reel mode detection: ANIMATED - User provided a storyline for animation

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:63:21)

  console.warn
    Invalid Telegram webhook secret token received

      30 |
      31 |         if (receivedToken !== secretToken) {
    > 32 |             console.warn('Invalid Telegram webhook secret token received');
         |                     ^
      33 |             throw new UnauthorizedError('Invalid webhook secret');
      34 |         }
      35 |

      at src/presentation/routes/telegramWebhook.ts:32:21
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at Route.dispatch (node_modules/router/lib/route.js:117:3)
      at handle (node_modules/router/index.js:435:11)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at node_modules/router/index.js:295:15
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at router.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at router.handle (node_modules/router/index.js:186:3)
      at router (node_modules/router/index.js:60:12)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at read (node_modules/body-parser/lib/read.js:43:5)
      at urlencodedParser (node_modules/body-parser/lib/types/urlencoded.js:58:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at trimPrefix (node_modules/router/index.js:342:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/body-parser/lib/read.js:172:5
      at invokeCallback (node_modules/raw-body/index.js:238:16)
      at done (node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (node_modules/raw-body/index.js:287:7)

  console.log
    [LLM] Reel mode detection: ANIMATED - User wants animation but no specific storyline

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:63:21)

  console.error
    [ERROR] UnauthorizedError: Invalid webhook secret

      67 |         console.warn(`[WARN] ${err.name}: ${err.message} (${req.method} ${req.path})`);
      68 |     } else {
    > 69 |         console.error(`[ERROR] ${err.name}: ${err.message}`);
         |                 ^
      70 |         if (err.stack) {
      71 |             console.error(err.stack);
      72 |         }

      at errorHandler (src/presentation/middleware/errorHandler.ts:69:17)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at Immediate.next (node_modules/router/index.js:291:5)
      at Immediate._onImmediate (node_modules/router/index.js:688:15)

  console.error
    UnauthorizedError: Invalid webhook secret
        at /Users/user1000/gitprojects/InstagramReelPoster/src/presentation/routes/telegramWebhook.ts:33:19
        at Layer.handleRequest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/layer.js:152:17)
        at next (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/route.js:157:13)
        at Route.dispatch (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/route.js:117:3)
        at handle (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:435:11)
        at Layer.handleRequest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/layer.js:152:17)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:295:15
        at processParams (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:582:12)
        at next (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:291:5)
        at router.handle (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:186:3)
        at router (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:60:12)
        at Layer.handleRequest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/layer.js:152:17)
        at trimPrefix (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:342:13)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:297:9
        at processParams (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:582:12)
        at next (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:291:5)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:688:15
        at next (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:276:14)
        at router.handle (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:186:3)
        at router (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:60:12)
        at Layer.handleRequest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/layer.js:152:17)
        at trimPrefix (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:342:13)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:297:9
        at processParams (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:582:12)
        at next (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:291:5)
        at read (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/body-parser/lib/read.js:43:5)
        at urlencodedParser (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/body-parser/lib/types/urlencoded.js:58:5)
        at Layer.handleRequest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/lib/layer.js:152:17)
        at trimPrefix (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:342:13)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:297:9
        at processParams (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:582:12)
        at next (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/router/index.js:291:5)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/body-parser/lib/read.js:172:5
        at AsyncResource.runInAsyncScope (node:async_hooks:213:14)
        at invokeCallback (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/raw-body/index.js:238:16)
        at done (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/raw-body/index.js:227:7)
        at IncomingMessage.onEnd (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/raw-body/index.js:287:7)
        at IncomingMessage.emit (node:events:508:28)
        at endReadableNT (node:internal/streams/readable:1701:12)
        at processTicksAndRejections (node:internal/process/task_queues:89:21)

      69 |         console.error(`[ERROR] ${err.name}: ${err.message}`);
      70 |         if (err.stack) {
    > 71 |             console.error(err.stack);
         |                     ^
      72 |         }
      73 |     }
      74 |

      at errorHandler (src/presentation/middleware/errorHandler.ts:71:21)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at Immediate.next (node_modules/router/index.js:291:5)
      at Immediate._onImmediate (node_modules/router/index.js:688:15)

PASS tests/integration/telegram-webhook.test.ts
  Integration: Telegram & Callback Pipeline
    ‚úì should reject unauthorized Telegram webhook requests (31 ms)
    ‚óã skipped should process a Telegram voice message and hit the Make.com callback

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Synthesized 11 chars in ~1.0s

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:71:21)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Trying xtts-api-server format...

      at XTTSTTSClient.synthesizeWithXttsApiServer (src/infrastructure/tts/XTTSTTSClient.ts:97:17)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Trying xtts-api-server format...

      at XTTSTTSClient.synthesizeWithXttsApiServer (src/infrastructure/tts/XTTSTTSClient.ts:97:17)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [Shotstack] Render render-123 status: done

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Synthesized 48 chars in ~4.8s

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:71:21)

  console.log
    [XTTS] Synthesizing with local XTTS server: http://localhost:8020

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:44:21)

  console.log
    [XTTS] Synthesized 48 chars in ~2.4s

      at XTTSTTSClient.synthesize (src/infrastructure/tts/XTTSTTSClient.ts:71:21)

PASS tests/unit/infrastructure/XTTSTTSClient.test.ts
  XTTSTTSClient
    constructor
      ‚úì should throw if server URL is missing (3 ms)
      ‚úì should create client with valid server URL
      ‚úì should remove trailing slash from server URL
    synthesize
      ‚úì should throw if text is empty
      ‚úì should throw if text is whitespace only (1 ms)
      ‚úì should call Coqui TTS format by default (6 ms)
      ‚úì should fall back to xtts-api-server format on 404 (24 ms)
      ‚úì should throw if xtts-api-server returns no audio URL (7 ms)
      ‚úì should throw descriptive error on Coqui API failure (4 ms)
      ‚úì should throw simple error on Coqui API failure with no data (4 ms)
      ‚úì should throw generic error on non-axios error (5 ms)
      ‚úì should estimate duration based on word count (3 ms)
      ‚úì should apply speed adjustment to duration estimate (5 ms)
    healthCheck
      ‚úì should return true when server is available (3 ms)
      ‚úì should return false when server is unavailable (6 ms)

  console.error
    [Shotstack] Error response: {
      "message": "Invalid payload"
    }

      336 |         } catch (error) {
      337 |             if (axios.isAxiosError(error)) {
    > 338 |                 console.error('[Shotstack] Error response:', JSON.stringify(error.response?.data, null, 2));
          |                         ^
      339 |                 const message = error.response?.data?.message ||
      340 |                     error.response?.data?.error ||
      341 |                     error.message;

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:338:25)
      at ShortstackVideoRenderer.render (src/infrastructure/video/ShortstackVideoRenderer.ts:138:26)
      at Object.<anonymous> (tests/unit/infrastructure/ShortstackVideoRenderer.test.ts:80:13)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Render started: render-fail

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [Shotstack] Render render-fail status: failed

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Render started: render-timeout

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Shotstack] Render render-timeout status: queued

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Render render-timeout status: queued

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.warn
    [ParableGenerator] Content mode detection failed, defaulting to direct-message: Error: Failed to parse LLM response as JSON: invalid json response...
        at OpenAIService.parseJSON (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:112:19)
        at ParableGenerator.detectContentMode (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/ParableGenerator.ts:68:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/infrastructure/OpenAILLMClient.parable.test.ts:82:28)

      74 |             };
      75 |         } catch (error) {
    > 76 |             console.warn('[ParableGenerator] Content mode detection failed, defaulting to direct-message:', error);
         |                     ^
      77 |             return {
      78 |                 contentMode: 'direct-message',
      79 |                 reason: 'Detection failed, defaulting to direct-message'

      at ParableGenerator.detectContentMode (src/infrastructure/llm/ParableGenerator.ts:76:21)
      at Object.<anonymous> (tests/unit/infrastructure/OpenAILLMClient.parable.test.ts:82:28)

  console.log
    [Shotstack] Render render-timeout status: queued

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Render started: render-no-url

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [Shotstack] Render render-no-url status: done

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

PASS tests/unit/infrastructure/OpenAILLMClient.parable.test.ts
  OpenAILLMClient Parable Methods
    detectContentMode
      ‚úì should detect parable mode when transcript mentions story keywords (12 ms)
      ‚úì should detect direct-message mode for commentary transcripts (5 ms)
      ‚úì should default to direct-message on parsing failure (8 ms)
    extractParableIntent
      ‚úì should extract theme-only intent from abstract transcript (4 ms)
      ‚úì should extract provided-story intent with constraints (4 ms)
    chooseParableSource
      ‚úì should choose culture and archetype based on intent (4 ms)
      ‚úì should respect cultural preference when provided (3 ms)
    generateParableScript
      ‚úì should generate 4-beat parable script (5 ms)
    generateParableHooks
      ‚úì should generate character-tension based hooks (4 ms)
    generateParableCaptionAndTags
      ‚úì should generate parable-optimized caption and hashtags (4 ms)

  console.log
    [Shotstack] Render started: render-123

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [Shotstack] Render render-123 status: done

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Render started: render-123

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    [Shotstack] Render render-123 status: done

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.32 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [Shotstack] Render started: render-loop

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.error
    [TTS] ‚ùå Primary TTS (Fish Audio) failed. Falling back to OpenAI.

      778 |             result = await this.deps.ttsClient.synthesize(text);
      779 |         } catch (error: any) {
    > 780 |             console.error('[TTS] ‚ùå Primary TTS (Fish Audio) failed. Falling back to OpenAI.');
          |                     ^
      781 |             console.error(`[TTS] Error Details: ${error.message}`);
      782 |             if (error.response) {
      783 |                 console.error(`[TTS] Status: ${error.response.status}`);

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:780:21)
      at Object.<anonymous> (tests/unit/TTSPriority.test.ts:61:24)

  console.error
    [TTS] Error Details: Fish Audio Rate Limit

      779 |         } catch (error: any) {
      780 |             console.error('[TTS] ‚ùå Primary TTS (Fish Audio) failed. Falling back to OpenAI.');
    > 781 |             console.error(`[TTS] Error Details: ${error.message}`);
          |                     ^
      782 |             if (error.response) {
      783 |                 console.error(`[TTS] Status: ${error.response.status}`);
      784 |                 console.error(`[TTS] Data: ${JSON.stringify(error.response.data)}`);

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:781:21)
      at Object.<anonymous> (tests/unit/TTSPriority.test.ts:61:24)

  console.warn
    [TTS] ‚ö†Ô∏è Using fallback TTS client...

      786 |
      787 |             if (this.deps.fallbackTTSClient) {
    > 788 |                 console.warn('[TTS] ‚ö†Ô∏è Using fallback TTS client...');
          |                         ^
      789 |                 result = await this.deps.fallbackTTSClient.synthesize(text);
      790 |             } else {
      791 |                 throw error;

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:788:25)
      at Object.<anonymous> (tests/unit/TTSPriority.test.ts:61:24)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [TTS] Applying speed adjustment (1.25x) with pitch 0.9...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:801:29)

  console.warn
    [TTS] ‚ö†Ô∏è Primary TTS speed adjustment failed: Speed adjust failed

      802 |                     result = await this.deps.ttsClient.synthesize(text, { speed, pitch: 0.9 });
      803 |                 } catch (error: any) {
    > 804 |                     console.warn('[TTS] ‚ö†Ô∏è Primary TTS speed adjustment failed:', error.message);
          |                             ^
      805 |
      806 |                     if (this.deps.fallbackTTSClient) {
      807 |                         console.log('[TTS] Trying fallback client for speed adjustment with pitch 0.9...');

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:804:29)
      at Object.<anonymous> (tests/unit/TTSPriority.test.ts:82:24)

  console.log
    [TTS] Trying fallback client for speed adjustment with pitch 0.9...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:807:33)

PASS tests/unit/TTSPriority.test.ts
  TTS Priority Logic (Unit)
    ‚úì Should prioritize Primary Client (Fish Audio) when it succeeds (1 ms)
    ‚úì Should user Fallback Client ONLY when Primary fails (1 ms)
    ‚úì Should handle speed adjustment failures gracefully (1 ms)

  console.log
    [Shotstack] Render render-loop status: done

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Shotstack] Request payload size: 1.11 KB

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:316:21)

  console.log
    [Shotstack] Render started: render-404

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

PASS tests/unit/presentation/reelRoutes.test.ts
  createReelRoutes
    route registration
      ‚úì should register POST /process-reel route
      ‚úì should register POST /retry-last route
      ‚úì should return a router instance (1 ms)
  Reel Routes Request Validation
    POST /process-reel validation
      ‚úì valid request body should pass validation
      ‚úì should require sourceAudioUrl
      ‚úì targetDurationRange should have valid min/max
      ‚úì invalid min > max should fail validation
    POST /retry-last validation
      ‚úì valid telegramChatId should pass validation
      ‚úì string telegramChatId should be convertible to number
      ‚úì invalid non-numeric telegramChatId should fail
  Reel Routes Response Structure
    ‚úì process-reel success response should have correct structure
    ‚úì retry-last success response should include originalJobId (1 ms)

  console.log
    [Shotstack] Render render-404 status: done

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

PASS tests/unit/infrastructure/ShortstackVideoRenderer.test.ts
  ShortstackVideoRenderer
    Constructor validation
      ‚úì should throw error when API key is missing (7 ms)
      ‚úì should create renderer with valid API key (1 ms)
    render() - Happy Path
      ‚úì should submit render and poll until completion (270 ms)
    render() - Error Handling
      ‚úì should throw descriptive error when render fails to start (24 ms)
      ‚úì should throw error when render status is failed (8 ms)
      ‚úì should timeout after max poll attempts (50 ms)
      ‚úì should throw when no render ID returned (4 ms)
      ‚úì should throw when completed response has no video URL (7 ms)
    Timeline construction
      ‚úì should create correct number of image clips (7 ms)
      ‚úì should set correct aspect ratio for reels (7 ms)
      ‚úì should loop music when shorter than video duration (8 ms)
    Rate limiting and retries
      ‚úì should handle 404 during polling gracefully (22 ms)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    
    === MUSIC TAG SELECTION BENCHMARK ===

      at Object.<anonymous> (tests/unit/application/MusicTagSelection.test.ts:201:21)

  console.log
    Indian Parable - Ekalavya: expect [indian, spiritual, epic] (culture: Indian)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    Chinese Wisdom: expect [chinese, zen, meditation] (culture: Chinese)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    Japanese Samurai: expect [japanese, epic, dramatic] (culture: Japanese)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    Alien Encounter: expect [psychedelic, ambient, alien, sci-fi] (culture: auto-detect)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    Motivational Speech: expect [epic, motivational, uplifting] (culture: auto-detect)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    Dark Mystery: expect [dark, suspense, mysterious] (culture: auto-detect)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    Arabic Desert Tale: expect [arabic, middle-eastern, adventure] (culture: Arabic)

      at tests/unit/application/MusicTagSelection.test.ts:203:25
          at Array.forEach (<anonymous>)

  console.log
    
    =====================================

      at Object.<anonymous> (tests/unit/application/MusicTagSelection.test.ts:205:21)

PASS tests/unit/application/MusicTagSelection.test.ts
  Music Tag Selection Benchmarks
    Fallback Tag Selection (No LLM)
      ‚úì Indian content should get indian + spiritual tags (1 ms)
      ‚úì Chinese content should get chinese + asian tags
      ‚úì Japanese content should get japanese + zen tags (1 ms)
      ‚úì Arabic content should get arabic + middle-eastern tags
      ‚úì Epic mood should get epic + cinematic tags
      ‚úì Dark mood should get dark + suspense tags
      ‚úì Motivational mood should get uplifting + motivational tags
      ‚úì Unknown mood should default to ambient + meditation
    Music Catalog Coverage
      ‚úì catalog should have at least 20 tracks (1 ms)
      ‚úì catalog should cover all major cultures
      ‚úì catalog should cover mood categories
    Selection Accuracy Summary
      ‚úì should print benchmark summary for documentation (4 ms)

PASS tests/unit/infrastructure/OpenAILLMClient.caption.test.ts
  OpenAILLMClient Caption Generation
    ‚úì should correctly parse caption and hashtags from OpenAI response (10 ms)
    ‚úì should provide default hashtags if the LLM response is missing them (4 ms)
    ‚úì should handle hashtags returned as a single string instead of an array (5 ms)
    ‚úì should add # prefix to hashtags if they are missing it (4 ms)

  console.log
    Loaded 10 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    Loaded 13 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [StandardReel] Step 1: Generating commentary for 3 segments (Target: 9 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    Loaded 14 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [StandardReel] Starting iterative generation for 3 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.log
    [StandardReel] Generated segment 1/3: "Segment 1 text...."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Generated segment 2/3: "Segment 2 text...."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Generated segment 3/3: "Segment 3 text...."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Iterative generation complete: 3 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 3 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

  console.log
    Loaded 15 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [StandardReel] Step 1: Generating commentary for 1 segments (Target: 20 words)

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:72:17)

  console.log
    Loaded 15 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    [StandardReel] Starting iterative generation for 1 segments...

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:115:17)

  console.log
    [StandardReel] Generated segment 1/1: "This is a very long sentence that will definitely ..."

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:142:29)

  console.log
    [StandardReel] Iterative generation complete: 1 segments

      at StandardReelGenerator.generateCommentary (src/infrastructure/llm/StandardReelGenerator.ts:151:17)

  console.log
    [StandardReel] Step 2: Generating visuals for 1 segments

      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:77:17)

  console.warn
    [LLM] Segment 1 exceeded word limit: 23 > 20. Truncating...

      388 |             }
      389 |
    > 390 |             console.warn(
          |                     ^
      391 |                 `[LLM] Segment ${index + 1} exceeded word limit: ${words.length} > ${maxWords}. Truncating...`
      392 |             );
      393 |

      at src/infrastructure/llm/StandardReelGenerator.ts:390:21
          at Array.map (<anonymous>)
      at StandardReelGenerator.enforceWordLimits (src/infrastructure/llm/StandardReelGenerator.ts:384:25)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:104:21)
      at Object.<anonymous> (tests/unit/infrastructure/TwoStepGeneration.test.ts:127:24)

  console.log
    Loaded 16 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

PASS tests/unit/infrastructure/TwoStepGeneration.test.ts
  Two-Step Generation Workflow
    ‚úì should execute iterative segment generation then visuals and merge results (3 ms)
    ‚úì should enforce word limits on generated commentary (2 ms)

  console.log
    Loaded 17 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 17 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 18 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 19 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 20 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 20 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 23 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

  console.log
    Loaded 26 jobs from disk

      at JobManager.loadFromDisk (src/application/JobManager.ts:56:25)

PASS tests/unit/application/JobManager.test.ts
  JobManager Edge Cases
    Job creation
      ‚úì should create jobs with unique IDs (3 ms)
      ‚úì should use default duration range from constructor (2 ms)
      ‚úì should override default duration range when provided (1 ms)
    Job retrieval
      ‚úì should return null for non-existent job ID (1 ms)
      ‚úì should retrieve created job by ID (1 ms)
    Job status updates
      ‚úì should update job status (1 ms)
      ‚úì should return null when updating non-existent job (1 ms)
    Job partial updates
      ‚úì should update job with partial data (1 ms)
      ‚úì should update updatedAt timestamp on partial update (12 ms)
    Job failure handling
      ‚úì should mark job as failed with error message (1 ms)
      ‚úì should return null when failing non-existent job (1 ms)
    Get all jobs
      ‚úì should return all created jobs (1 ms)
    Get jobs by status
      ‚úì should filter jobs by status (1 ms)
    Clear jobs
      ‚úì should clear all jobs (1 ms)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.log
    [OpenRouter] Image generated successfully

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:62:21)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.error
    [OpenRouter] Image generation failed: { error: { message: 'Model not found' } }

      66 |             if (axios.isAxiosError(error)) {
      67 |                 const message = error.response?.data?.error?.message || error.message;
    > 68 |                 console.error(`[OpenRouter] Image generation failed:`, error.response?.data);
         |                         ^
      69 |                 throw new Error(`OpenRouter image generation failed: ${message}`);
      70 |             }
      71 |             throw error;

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:68:25)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterImageClient.test.ts:186:13)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

  console.error
    [OpenRouter] Image generation failed: undefined

      66 |             if (axios.isAxiosError(error)) {
      67 |                 const message = error.response?.data?.error?.message || error.message;
    > 68 |                 console.error(`[OpenRouter] Image generation failed:`, error.response?.data);
         |                         ^
      69 |                 throw new Error(`OpenRouter image generation failed: ${message}`);
      70 |             }
      71 |             throw error;

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:68:25)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterImageClient.test.ts:203:13)

  console.log
    [OpenRouter] Generating image with google/gemini-2.5-flash-image...

      at OpenRouterImageClient.generateImage (src/infrastructure/images/OpenRouterImageClient.ts:34:21)

PASS tests/unit/infrastructure/OpenRouterImageClient.test.ts
  OpenRouterImageClient
    constructor
      ‚úì should throw error if apiKey is empty (4 ms)
      ‚úì should create client with valid apiKey
      ‚úì should use default model if not provided
      ‚úì should use custom model if provided
      ‚úì should use default baseUrl if not provided
      ‚úì should use custom baseUrl if provided
    generateImage
      ‚úì should return image URL from images array (2 ms)
      ‚úì should return direct URL from images array
      ‚úì should extract base64 from content fallback
      ‚úì should extract URL from content fallback
      ‚úì should send request with correct headers (1 ms)
      ‚úì should append style to prompt
    error handling
      ‚úì should throw with error message on API failure (1 ms)
      ‚úì should throw if no image can be extracted (1 ms)
      ‚úì should rethrow non-axios errors
    resetSequence
      ‚úì should reset sequence state (1 ms)
    extractCompactContext
      ‚úì should extract location from prompt
      ‚úì should extract lighting from prompt
      ‚úì should fallback to core elements if no matches

PASS tests/integration/animated-video-workflow.test.ts
  Integration: Animated Video Workflow
    ‚úì should be able to instantiate Orchestrator with AnimatedVideoClient (1 ms)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/unit/domain/DurationCalculator.test.ts
  DurationCalculator
    estimateSpeakingDuration
      ‚úì should estimate duration based on word count and speaking rate (1 ms)
      ‚úì should use config-based speaking rate (default 2.3 wps in tests)
      ‚úì should handle empty text
      ‚úì should handle text with extra whitespace
    calculateTargetWordCount
      ‚úì should calculate word count for target duration (targeting 98% safety)
      ‚úì should use floor to ensure no overshoot
    isDurationWithinTolerance
      ‚úì should return true when within default tolerance of 1.5s
      ‚úì should return false when outside default tolerance
      ‚úì should use custom tolerance (1 ms)
    calculateSpeedAdjustment
      ‚úì should return 1.0 for matching durations
      ‚úì should return speed > 1 when actual is longer than target
      ‚úì should return speed < 1 when actual is shorter than target
      ‚úì should clamp to min/max speed bounds
      ‚úì should use custom speed bounds
      ‚úì should return 1.0 for invalid inputs
    needsTextAdjustment
      ‚úì should return "ok" when within [95%, 100%] range (default 5% tolerance)
      ‚úì should return "shorter" even for small overshoots
      ‚úì should return "longer" when text is below 95%
      ‚úì should return "shorter" when text is too long
      ‚úì should return "longer" when text is too short
      ‚úì should use custom tolerance
    distributeSegmentDurations
      ‚úì should distribute duration evenly across segments
      ‚úì should handle non-even division
      ‚úì should return empty array for zero segments (1 ms)
      ‚úì should handle single segment
    calculateSegmentTimings
      ‚úì should calculate start and end times for segments
      ‚úì should handle empty durations
      ‚úì should handle single segment
      ‚úì should handle decimal durations

PASS tests/unit/infrastructure/KieMusicGeneratorClient.test.ts
  KieMusicGeneratorClient
    constructor
      ‚úì should throw error if apiKey is empty (4 ms)
      ‚úì should create client with valid apiKey
      ‚úì should use default baseUrl if not provided
      ‚úì should use custom baseUrl if provided
      ‚úì should use default poll interval of 5000ms
      ‚úì should use default max poll attempts of 60
    generateMusic
      ‚úì should start generation and poll for completion (1 ms)
      ‚úì should extract tags from description prompt
    startGeneration
      ‚úì should throw if no job ID returned
      ‚úì should throw with error message on API failure
    pollForCompletion
      ‚úì should poll multiple times before success (1 ms)
      ‚úì should throw on failed status
      ‚úì should throw on timeout (23 ms)
      ‚úì should throw if no audio URL in completed response
    buildDescriptionPrompt
      ‚úì should include ambient and eastern requirements (1 ms)
    extractTagsFromPrompt
      ‚úì should always include ai-generated tag

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.log
    [OpenRouter] Transcription successful (49 chars)

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:81:21)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.log
    [OpenRouter] Transcription successful (41 chars)

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:81:21)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.log
    [OpenRouter] Transcription successful (4 chars)

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:81:21)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.error
    [OpenRouter] Unexpected response format: {}

      69 |
      70 |             if (!response.data || !response.data.choices || !response.data.choices[0]) {
    > 71 |                 console.error('[OpenRouter] Unexpected response format:', JSON.stringify(response.data, null, 2));
         |                         ^
      72 |                 throw new Error('OpenRouter returned an invalid response structure');
      73 |             }
      74 |

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:71:25)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:127:13)

  console.error
    [OpenRouter] Unexpected error: Error: OpenRouter returned an invalid response structure
        at OpenRouterTranscriptionClient.transcribe (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:72:23)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:127:13)

      87 |                 throw new Error(`Transcription failed via OpenRouter: ${message}`);
      88 |             }
    > 89 |             console.error('[OpenRouter] Unexpected error:', error);
         |                     ^
      90 |             throw error;
      91 |         }
      92 |     }

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:89:21)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:127:13)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.warn
    [OpenRouter] Received empty content from model

      75 |             const content = response.data.choices[0].message?.content;
      76 |             if (!content) {
    > 77 |                 console.warn('[OpenRouter] Received empty content from model');
         |                         ^
      78 |                 throw new Error('OpenRouter model returned empty transcription');
      79 |             }
      80 |

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:77:25)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:142:13)

  console.error
    [OpenRouter] Unexpected error: Error: OpenRouter model returned empty transcription
        at OpenRouterTranscriptionClient.transcribe (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:78:23)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:142:13)

      87 |                 throw new Error(`Transcription failed via OpenRouter: ${message}`);
      88 |             }
    > 89 |             console.error('[OpenRouter] Unexpected error:', error);
         |                     ^
      90 |             throw error;
      91 |         }
      92 |     }

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:89:21)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:142:13)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.warn
    [OpenRouter] Received empty content from model

      75 |             const content = response.data.choices[0].message?.content;
      76 |             if (!content) {
    > 77 |                 console.warn('[OpenRouter] Received empty content from model');
         |                         ^
      78 |                 throw new Error('OpenRouter model returned empty transcription');
      79 |             }
      80 |

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:77:25)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:157:13)

  console.error
    [OpenRouter] Unexpected error: Error: OpenRouter model returned empty transcription
        at OpenRouterTranscriptionClient.transcribe (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:78:23)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:157:13)

      87 |                 throw new Error(`Transcription failed via OpenRouter: ${message}`);
      88 |             }
    > 89 |             console.error('[OpenRouter] Unexpected error:', error);
         |                     ^
      90 |             throw error;
      91 |         }
      92 |     }

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:89:21)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:157:13)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.error
    [OpenRouter] API Error: {
      "error": {
        "message": "Rate limit exceeded"
      }
    }

      83 |         } catch (error: any) {
      84 |             if (axios.isAxiosError(error) && error.response) {
    > 85 |                 console.error('[OpenRouter] API Error:', JSON.stringify(error.response.data, null, 2));
         |                         ^
      86 |                 const message = error.response.data?.error?.message || error.message;
      87 |                 throw new Error(`Transcription failed via OpenRouter: ${message}`);
      88 |             }

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:85:25)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:175:13)

  console.log
    [OpenRouter] Transcribing source (google/gemini-2.0-flash-001): https://example.com/audio.mp3

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:35:21)

  console.error
    [OpenRouter] Unexpected error: Error: Network failure
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:182:52)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      87 |                 throw new Error(`Transcription failed via OpenRouter: ${message}`);
      88 |             }
    > 89 |             console.error('[OpenRouter] Unexpected error:', error);
         |                     ^
      90 |             throw error;
      91 |         }
      92 |     }

      at OpenRouterTranscriptionClient.transcribe (src/infrastructure/transcription/OpenRouterTranscriptionClient.ts:89:21)
      at Object.<anonymous> (tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts:186:13)

PASS tests/unit/infrastructure/OpenRouterTranscriptionClient.test.ts
  OpenRouterTranscriptionClient
    constructor
      ‚úì should throw error if apiKey is empty (3 ms)
      ‚úì should create client with valid apiKey
      ‚úì should use default model if not provided
      ‚úì should use custom model if provided
      ‚úì should use default baseUrl if not provided
    transcribe
      ‚úì should throw error if audioUrl is empty (1 ms)
      ‚úì should return transcription on success (1 ms)
      ‚úì should trim whitespace from transcription
      ‚úì should send correct request payload
    error handling
      ‚úì should throw on invalid response structure (1 ms)
      ‚úì should throw on empty content
      ‚úì should throw on null content (1 ms)
      ‚úì should throw with API error message on axios error
      ‚úì should rethrow non-axios errors (1 ms)

  console.log
    [FFmpeg] Starting render job 95477d16-c94c-42c6-98ee-1ff63e1efbd3

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:33:21)

  console.log
    [FFmpeg] Downloading assets for 95477d16-c94c-42c6-98ee-1ff63e1efbd3...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:36:21)

  console.log
    [FFmpeg] Processing video...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:40:21)

  console.log
    [FFmpeg] Uploading result...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:45:21)

  console.log
    [FFmpeg] Starting render job 30b21f15-7f06-4d56-88da-b99368713cb0

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:33:21)

  console.log
    [FFmpeg] Downloading assets for 30b21f15-7f06-4d56-88da-b99368713cb0...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:36:21)

  console.log
    [FFmpeg] Processing video...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:40:21)

  console.log
    [FFmpeg] Uploading result...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:45:21)

  console.log
    [FFmpeg] Starting render job f8cccf93-df10-487f-a4d8-ddddde2e0266

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:33:21)

  console.log
    [FFmpeg] Downloading assets for f8cccf93-df10-487f-a4d8-ddddde2e0266...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:36:21)

  console.log
    [FFmpeg] Processing video...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:40:21)

  console.log
    [FFmpeg] Uploading result...

      at FFmpegVideoRenderer.render (src/infrastructure/video/FFmpegVideoRenderer.ts:45:21)

PASS tests/unit/infrastructure/FFmpegVideoRenderer.complex.test.ts
  FFmpegVideoRenderer (Indexing Fix)
    ‚úì should use [2:v] for visuals when music is present (4 ms)
    ‚úì should use [1:v] for visuals when music is NOT present (2 ms)
    ‚úì should handle image segments correctly without music (2 ms)

PASS tests/unit/infrastructure/OpenAILinkedInDraftService.test.ts
  OpenAILinkedInDraftService (AC4)
    Constructor
      ‚úì should create service with valid API key
      ‚úì should reject empty API key (3 ms)
    generateDraftContent
      ‚úì should generate draft from raw note
      ‚úì should include raw note in prompt
      ‚úì should use JSON response format
      ‚úì should include outreach optimization in system prompt (1 ms)
    Response Validation
      ‚úì should reject response missing core_tension
      ‚úì should reject response with fewer than 3 bullets
      ‚úì should reject response with no closer options

PASS tests/unit/presentation/TelegramTextPrompt.test.ts
  Telegram Text Prompt Support
    ReelJobInput Validation
      ‚úì should accept sourceAudioUrl input
      ‚úì should accept transcript input (text prompt)
      ‚úì should reject input with neither audio nor transcript (3 ms)
      ‚úì should reject empty transcript
      ‚úì should trim transcript whitespace
    Message Type Detection
      ‚úì should identify voice messages
      ‚úì should identify audio messages
      ‚úì should identify text messages
      ‚úì should ignore empty text messages
      ‚úì should identify commands (/start, /help)
    Edge Cases
      ‚úì should handle very long text prompts
      ‚úì should handle special characters in text
      ‚úì should handle unicode/emoji in text

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [TrainingData] Collected voice sample: voice_1766745601563 (15s)

      at TrainingDataCollector.collectVoiceSample (src/infrastructure/training/TrainingDataCollector.ts:84:17)

  console.log
    [TrainingData] Collected text sample: text_1766745601563 (2 words)

      at TrainingDataCollector.collectTextSample (src/infrastructure/training/TrainingDataCollector.ts:110:17)

  console.log
    [TrainingData] Exported 1 samples to test_data/xtts_export

      at TrainingDataCollector.exportForXTTS (src/infrastructure/training/TrainingDataCollector.ts:176:17)

  console.log
    [TrainingData] Exported 1 samples to test_data/llm_export/training_data.jsonl

      at TrainingDataCollector.exportForLLM (src/infrastructure/training/TrainingDataCollector.ts:206:17)

PASS tests/unit/infrastructure/TrainingDataCollector.test.ts
  TrainingDataCollector
    constructor
      ‚úì should create directories if they do not exist (1 ms)
    collectVoiceSample
      ‚úì should throw if training mode is disabled (4 ms)
      ‚úì should write voice sample to disk
    collectTextSample
      ‚úì should write text sample to disk (1 ms)
    getStats
      ‚úì should calculate stats from disk
      ‚úì should handle corrupt files graciously
    exportForXTTS
      ‚úì should create metadata json for XTTS (1 ms)
    exportForLLM
      ‚úì should create jsonl for LLM

  console.warn
    Internal catalog fallback chain failed: Error: Catalog error
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:18:35)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:305:39
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:312:13)
        at Object.mockConstructor [as searchTracks] (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:102:19)
        at MusicSelector.findBestTrack (/Users/user1000/gitprojects/InstagramReelPoster/src/application/MusicSelector.ts:137:38)
        at MusicSelector.selectMusic (/Users/user1000/gitprojects/InstagramReelPoster/src/application/MusicSelector.ts:65:36)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:36:43)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      93 |             }
      94 |         } catch (error) {
    > 95 |             console.warn('Internal catalog fallback chain failed:', error);
         |                     ^
      96 |         }
      97 |
      98 |         // 3. Fall back to AI generation

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:95:21)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:36:28)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:36:28)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:46:28)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.error
    AI music generation failed: Error: Payment required: 402
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:55:64)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      107 |                 return { track, source: 'ai' };
      108 |             } catch (error) {
    > 109 |                 console.error('AI music generation failed:', error);
          |                         ^
      110 |
      111 |                 // Catalog Safety Net (Absolute last resort before hardcoded)
      112 |                 try {

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:109:25)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:58:28)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:58:28)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.error
    AI music generation failed: Error: Rate limit exceeded
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:65:64)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      107 |                 return { track, source: 'ai' };
      108 |             } catch (error) {
    > 109 |                 console.error('AI music generation failed:', error);
          |                         ^
      110 |
      111 |                 // Catalog Safety Net (Absolute last resort before hardcoded)
      112 |                 try {

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:109:25)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:68:28)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:68:28)

  console.warn
    External catalog search failed: Error: Catalog error
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:18:35)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:305:39
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:312:13)
        at Object.mockConstructor [as searchTracks] (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:102:19)
        at MusicSelector.findBestTrack (/Users/user1000/gitprojects/InstagramReelPoster/src/application/MusicSelector.ts:137:38)
        at MusicSelector.selectMusic (/Users/user1000/gitprojects/InstagramReelPoster/src/application/MusicSelector.ts:53:42)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:92:43)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      56 |                 }
      57 |             } catch (error) {
    > 58 |                 console.warn('External catalog search failed:', error);
         |                         ^
      59 |             }
      60 |         }
      61 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:58:25)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:92:28)

  console.warn
    External catalog search failed: Error: Catalog error
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:18:35)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:305:39
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:312:13)
        at Object.mockConstructor [as searchTracks] (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-mock/build/index.js:102:19)
        at MusicSelector.findBestTrack (/Users/user1000/gitprojects/InstagramReelPoster/src/application/MusicSelector.ts:137:38)
        at MusicSelector.selectMusic (/Users/user1000/gitprojects/InstagramReelPoster/src/application/MusicSelector.ts:53:42)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:187:43)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      56 |                 }
      57 |             } catch (error) {
    > 58 |                 console.warn('External catalog search failed:', error);
         |                         ^
      59 |             }
      60 |         }
      61 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:58:25)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:187:28)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.log
    [Pixabay] Searching for: "sunset"

      at PixabayImageClient.generateImage (src/infrastructure/images/PixabayImageClient.ts:30:21)

  console.error
    AI music generation failed: Error: AI unavailable
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/MusicSelector.test.ts:183:57)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      107 |                 return { track, source: 'ai' };
      108 |             } catch (error) {
    > 109 |                 console.error('AI music generation failed:', error);
          |                         ^
      110 |
      111 |                 // Catalog Safety Net (Absolute last resort before hardcoded)
      112 |                 try {

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:109:25)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:187:28)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/application/MusicSelector.test.ts:187:28)

  console.log
    [Pixabay] Searching for: "a dog running on the beach under the moonlight"

      at PixabayImageClient.generateImage (src/infrastructure/images/PixabayImageClient.ts:30:21)

PASS tests/unit/application/MusicSelector.test.ts
  MusicSelector Edge Cases
    Malformed catalog handling
      ‚úì should return null when internal catalog throws error (music is optional) (5 ms)
      ‚úì should return null when catalog returns empty and no AI (1 ms)
    AI generator failure scenarios
      ‚úì should return null when AI throws 402 payment required
      ‚úì should return null when AI throws rate limit (1 ms)
      ‚úì should try catalog safety net after AI failure before using hardcoded backup
    External catalog fallback
      ‚úì should fall back to internal when external catalog fails
      ‚úì should use external catalog track when available
    Duration boundary conditions
      ‚úì should handle duration exactly at min boundary (70% of target) (1 ms)
      ‚úì should handle duration exactly at max boundary (150% of target)
      ‚úì should pick best scoring track when multiple match
    Multi-pass relaxation
      ‚úì should relax duration constraint when no exact match
      ‚úì should relax tag constraint when no tag match
    Complete fallback chain
      ‚úì should traverse full chain: external ‚Üí internal ‚Üí AI ‚Üí null when all fail (1 ms)

  console.log
    [Pixabay] Searching for: "very specific query that yields nothing"

      at PixabayImageClient.generateImage (src/infrastructure/images/PixabayImageClient.ts:30:21)

  console.log
    [Pixabay] No results, trying broader search...

      at PixabayImageClient.generateImage (src/infrastructure/images/PixabayImageClient.ts:51:29)

  console.log
    [Pixabay] Searching for: "nothing found"

      at PixabayImageClient.generateImage (src/infrastructure/images/PixabayImageClient.ts:30:21)

PASS tests/unit/infrastructure/PixabayImageClient.test.ts
  PixabayImageClient
    ‚úì should throw if api key is missing (2 ms)
    ‚úì should clean simple prompts (2 ms)
    ‚úì should clean complex prompts
    ‚úì should retry with broader query if no results found
    ‚úì should throw error if both attempts fail (1 ms)

  console.warn
    External catalog search failed: Error: Catalog error
        at createFailingCatalog (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/core-logic.test.ts:75:51)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/core-logic.test.ts:117:37)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      56 |                 }
      57 |             } catch (error) {
    > 58 |                 console.warn('External catalog search failed:', error);
         |                         ^
      59 |             }
      60 |         }
      61 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:58:25)
      at Object.<anonymous> (tests/unit/core-logic.test.ts:121:28)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/core-logic.test.ts:144:28)

  console.log
    No tracks matched both tags and duration, trying tags-only match

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:69:25)

  console.log
    No tracks matched with tags, trying duration-only match in internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:76:25)

  console.log
    Relaxing all constraints, picking any track from internal catalog

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:83:25)

  console.error
    AI music generation failed: Error: Generator error
        at createFailingGenerator (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/core-logic.test.ts:86:52)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/core-logic.test.ts:151:38)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      107 |                 return { track, source: 'ai' };
      108 |             } catch (error) {
    > 109 |                 console.error('AI music generation failed:', error);
          |                         ^
      110 |
      111 |                 // Catalog Safety Net (Absolute last resort before hardcoded)
      112 |                 try {

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:109:25)
      at Object.<anonymous> (tests/unit/core-logic.test.ts:154:28)

  console.warn
    No background music available. Video will be rendered without music.

      123 |
      124 |         // 4. No music available - return null (music is optional)
    > 125 |         console.warn('No background music available. Video will be rendered without music.');
          |                 ^
      126 |         return null;
      127 |     }
      128 |

      at MusicSelector.selectMusic (src/application/MusicSelector.ts:125:17)
      at Object.<anonymous> (tests/unit/core-logic.test.ts:154:28)

PASS tests/unit/core-logic.test.ts
  Segment Count Calculation
    Mathematical formula
      ‚úì should calculate 3 segments for 10-15s duration
      ‚úì should calculate 2 segments for 5-10s duration
      ‚úì should calculate 6 segments for 25-35s duration
      ‚úì should clamp to minimum 2 segments for very short videos
      ‚úì should clamp to maximum 6 segments for very long videos
    Deterministic behavior
      ‚úì should return same count for same input across multiple calls
  MusicSelector
    Catalog matching
      ‚úì should return track from internal catalog when found (1 ms)
      ‚úì should prefer external catalog over internal when both have matches
    Fallback chain
      ‚úì should fall back to internal when external fails (4 ms)
      ‚úì should fall back to AI generator when both catalogs have no matches (1 ms)
      ‚úì should return null when all sources fail or empty and no generator (music is optional)
      ‚úì should return null when all sources including generator fail (music is optional) (1 ms)
  ReelManifest
    Construction validation
      ‚úì should create manifest with valid inputs
      ‚úì should throw on zero duration (1 ms)
      ‚úì should throw on empty segments
      ‚úì should throw on empty voiceover URL
      ‚úì should throw if any segment missing imageUrl
    Timing calculations
      ‚úì should preserve segment start and end times (1 ms)
      ‚úì should trim whitespace from URLs

PASS tests/unit/infrastructure/OpenAITTSClient.test.ts
  OpenAITTSClient
    constructor
      ‚úì should throw error if apiKey is empty (2 ms)
      ‚úì should create client with valid apiKey
      ‚úì should use default voice "alloy" if not provided
      ‚úì should use custom voice if provided (1 ms)
    synthesize
      ‚úì should throw error if text is empty
      ‚úì should throw error if text is only whitespace
      ‚úì should return base64 audio URL on success
      ‚úì should use custom format if provided
      ‚úì should pass speed option to API
      ‚úì should estimate duration based on word count
      ‚úì should adjust duration estimate based on speed
    error handling
      ‚úì should throw with OpenAI error message on API failure (1 ms)
      ‚úì should throw with generic error message if no specific error
      ‚úì should rethrow non-axios errors

PASS tests/unit/presentation/jobRoutes.test.ts
  createJobRoutes
    route registration
      ‚úì should register GET /jobs/:jobId route
      ‚úì should register GET /jobs route (1 ms)
      ‚úì should register POST /test-webhook route
      ‚úì should return a router instance
    GET /jobs/:jobId
      ‚úì should return job data for existing job
    GET /jobs
      ‚úì should list all jobs (1 ms)
  Job Routes Response Structure
    ‚úì completed job response should include all fields (1 ms)
    ‚úì failed job response should include error
    ‚úì processing job response should include step

PASS tests/unit/infrastructure/CloudinaryStorageClient.test.ts
  CloudinaryStorageClient
    constructor
      ‚úì should throw error if cloudName is missing (3 ms)
      ‚úì should throw error if apiKey is missing
      ‚úì should throw error if apiSecret is missing (1 ms)
      ‚úì should configure cloudinary on creation
    uploadFromUrl
      ‚úì should upload file and return url and publicId
      ‚úì should use provided folder and publicId
      ‚úì should throw on upload failure
    uploadRawContent
      ‚úì should write content to temp file and upload (1 ms)
      ‚úì should cleanup temp file after upload
      ‚úì should cleanup temp file even on error
    uploadAudio
      ‚úì should upload audio with video resource type
    uploadImage
      ‚úì should upload image with image resource type
    uploadVideo
      ‚úì should upload video with video resource type
    getUrl
      ‚úì should return cloudinary URL for resource
      ‚úì should use provided resource type (1 ms)
    delete
      ‚úì should delete resource from cloudinary
      ‚úì should use provided resource type for deletion

PASS tests/unit/prompts/ParablePromptValidation.test.ts
  Parable Prompt Acceptance Criteria
    AC1: detectContentMode
      ‚úì should return valid contentMode enum (1 ms)
      ‚úì should always have a reason string
    AC2: extractParableIntent
      ‚úì should have valid sourceType enum
      ‚úì should have non-empty coreTheme
      ‚úì should have non-empty moral
      ‚úì CRITICAL: providedStoryContext must contain character names for provided-story
      ‚úì should detect culturalPreference when mentioned
      ‚úì should pass isParableIntent type guard
    AC3: chooseParableSource
      ‚úì should have valid culture enum
      ‚úì should have valid archetype enum
      ‚úì should have non-empty rationale (1 ms)
      ‚úì should respect culturalPreference from intent
    AC4: generateParableScript
      ‚úì should have exactly 4 beats
      ‚úì should have correct beat roles in order
      ‚úì CRITICAL: total duration must be >= 30 seconds
      ‚úì CRITICAL: character names must appear in narration when providedStoryContext has them
      ‚úì CRITICAL: teacher name should appear when in providedStoryContext
      ‚úì each beat should have narration > 10 characters
      ‚úì each beat should have textOnScreen > 3 characters
      ‚úì each imagePrompt should start with "2D stylized cartoon"
      ‚úì beat durations should be within expected ranges
      ‚úì should pass isParableScriptPlan type guard
      ‚úì VIRAL: hook first sentence should be short and grab-worthy (< 80 chars) (1 ms)
      ‚úì VIRAL: turn beat should contain a re-hook phrase pattern
      ‚úì VIRAL: language should be simple (sentences average < 15 words)
    AC5: generateParableHooks
      ‚úì should return an array
      ‚úì should have at least 3 hooks
      ‚úì each hook should be < 100 characters
      ‚úì at least one hook should reference the main character
    AC6: generateParableCaptionAndTags
      ‚úì captionBody should be non-empty (> 20 chars)
      ‚úì CRITICAL: should have at least 8 hashtags
      ‚úì all hashtags should start with #
      ‚úì should include brand hashtag #ChallengingView
      ‚úì should include parable-related hashtag
      ‚úì should have no duplicate hashtags

  console.log
    [LinkedIn] Posting to Make.com webhook: https://hook.eu2.make.com/test-webhook-id...

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:28:21)

  console.log
    [LinkedIn] Make.com response status: 200

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:42:21)

  console.log
    [LinkedIn] Posting to Make.com webhook: https://hook.eu2.make.com/test-webhook-id...

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:28:21)

  console.log
    [LinkedIn] Make.com response status: 200

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:42:21)

  console.log
    [LinkedIn] Posting to Make.com webhook: https://hook.eu2.make.com/test-webhook-id...

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:28:21)

  console.error
    [LinkedIn] Failed to post: Unknown error

      58 |         } catch (error) {
      59 |             const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    > 60 |             console.error(`[LinkedIn] Failed to post: ${errorMessage}`);
         |                     ^
      61 |
      62 |             if (axios.isAxiosError(error) && error.response) {
      63 |                 return {

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:60:21)
      at Object.<anonymous> (tests/unit/infrastructure/MakeLinkedInPosterService.test.ts:109:28)

  console.log
    [LinkedIn] Posting to Make.com webhook: https://hook.eu2.make.com/test-webhook-id...

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:28:21)

  console.error
    [LinkedIn] Failed to post: Network error

      58 |         } catch (error) {
      59 |             const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    > 60 |             console.error(`[LinkedIn] Failed to post: ${errorMessage}`);
         |                     ^
      61 |
      62 |             if (axios.isAxiosError(error) && error.response) {
      63 |                 return {

      at MakeLinkedInPosterService.postToLinkedIn (src/infrastructure/linkedin/MakeLinkedInPosterService.ts:60:21)
      at Object.<anonymous> (tests/unit/infrastructure/MakeLinkedInPosterService.test.ts:124:28)

PASS tests/unit/infrastructure/MakeLinkedInPosterService.test.ts
  MakeLinkedInPosterService
    Constructor
      ‚úì should create service with valid webhook URL and API key
      ‚úì should reject empty webhook URL (2 ms)
      ‚úì should reject empty API key
      ‚úì should reject whitespace-only webhook URL
    postToLinkedIn
      ‚úì should post content successfully (1 ms)
      ‚úì should send correct payload to webhook (1 ms)
      ‚úì should handle 401 unauthorized error
      ‚úì should handle network errors (1 ms)

PASS tests/unit/CallbackOnlyOnSuccess.test.ts
  Callback Only On Success
    ‚úì ReelOrchestrator should NOT call notifyCallback on failure path (1 ms)
    ‚úì ReelOrchestrator should call notifyCallback on success path
    ‚úì notifyCallback should check for valid video URL before sending

PASS tests/unit/infrastructure/MockAnimatedVideoClient.test.ts
  IAnimatedVideoClient
    MockAnimatedVideoClient
      ‚úì should implement IAnimatedVideoClient interface
      ‚úì should return a video URL matching requested duration
      ‚úì should accept theme and mood parameters
      ‚úì should handle minimum required parameters

  console.log
    [job_123] No Telegram chat - auto-approving script

      at ApprovalService.requestApproval (src/application/ApprovalService.ts:59:21)

  console.log
    [job_123] No Telegram chat - auto-approving script

      at ApprovalService.requestApproval (src/application/ApprovalService.ts:59:21)

  console.log
    [job_abc] User approved script

      at ApprovalService.handleCallback (src/application/ApprovalService.ts:101:17)

  console.log
    [job_reject] User rejected visuals with feedback: Make it more colorful

      at ApprovalService.handleCallback (src/application/ApprovalService.ts:101:17)

  console.log
    [job_pending] User approved script

      at ApprovalService.handleCallback (src/application/ApprovalService.ts:101:17)

  console.log
    [job_empty] User approved script

      at ApprovalService.handleCallback (src/application/ApprovalService.ts:101:17)

  console.log
    [job_long] User approved script

      at ApprovalService.handleCallback (src/application/ApprovalService.ts:101:17)

PASS tests/unit/application/ApprovalService.test.ts
  ApprovalService
    Checkpoint Configuration
      ‚úì script checkpoint should have 60s timeout
      ‚úì visuals checkpoint should have 120s timeout
    Auto-Approve without Telegram
      ‚úì should auto-approve if no chatId provided (1 ms)
      ‚úì should auto-approve if TelegramService is null (1 ms)
    User Approval Handling
      ‚úì should handle user approval callback
      ‚úì should handle user rejection with feedback (1 ms)
    Pending State
      ‚úì should track pending approvals
      ‚úì should return false for non-pending callback
    Message Content
      ‚úì script checkpoint should show üìù emoji
      ‚úì visuals checkpoint should show üé® emoji
      ‚úì message should include timeout warning
    Edge Cases
      ‚úì should handle empty summary
      ‚úì should handle very long summary (1 ms)
      ‚úì cleanup should remove old approvals

PASS tests/unit/domain/Track.test.ts
  Track
    createTrack
      ‚úì should create a valid track with required properties
      ‚úì should create a track with optional properties
      ‚úì should normalize tags to lowercase
      ‚úì should trim whitespace from fields (1 ms)
      ‚úì should throw error for empty id (2 ms)
      ‚úì should throw error for non-positive duration
      ‚úì should throw error for empty audioUrl
    trackMatchesTags
      ‚úì should return true when at least one tag matches
      ‚úì should return false when no tags match (1 ms)
      ‚úì should handle case-insensitive matching
      ‚úì should return false for empty required tags
    trackFitsDuration
      ‚úì should return true when track duration is within tolerance
      ‚úì should return false when track duration is outside tolerance
      ‚úì should use custom tolerance

PASS tests/unit/domain/Segment.test.ts
  Segment
    createSegment
      ‚úì should create a valid segment with all required properties
      ‚úì should create a segment with optional properties
      ‚úì should trim whitespace from text fields
      ‚úì should throw error for negative index (2 ms)
      ‚úì should throw error for negative startSeconds
      ‚úì should throw error when endSeconds <= startSeconds (1 ms)
      ‚úì should throw error for empty commentary
      ‚úì should throw error for empty imagePrompt
    getSegmentDuration
      ‚úì should calculate correct duration
      ‚úì should handle decimal durations

PASS tests/unit/infrastructure/FFmpegVideoRenderer.test.ts
  FFmpegVideoRenderer
    constructor
      ‚úì should create renderer with cloudinary client
      ‚úì should set temp directory path
      ‚úì should create temp directory if it does not exist
      ‚úì should not create temp directory if it exists
      ‚úì should store cloudinary client reference (1 ms)
    temp directory handling
      ‚úì should use os.tmpdir for base path

PASS tests/unit/application/CaptionService.test.ts
  CaptionService
    ‚úì should generate a caption and tags
    ‚úì should prepend series label and add series hashtag when in series mode
    ‚úì should not add duplicate series hashtag

PASS tests/unit/domain/LinkedInDraft.test.ts
  LinkedInDraft Entity
    AC1: LinkedIn Detection
      ‚úì should detect "linkedin" keyword (lowercase)
      ‚úì should detect "LinkedIn" keyword (proper case) (1 ms)
      ‚úì should detect "LINKEDIN" keyword (uppercase)
      ‚úì should detect linkedin in the middle of text
      ‚úì should NOT detect similar words
      ‚úì should NOT detect unrelated text
    AC1: Raw Note Extraction
      ‚úì should remove "linkedin" keyword and trim
      ‚úì should handle linkedin in the middle
      ‚úì should handle mixed case
    AC2: LinkedInDraft Creation
      ‚úì should create a valid LinkedInDraft
      ‚úì should reject empty id (3 ms)
      ‚úì should reject empty rawNote
      ‚úì should reject empty hook
      ‚úì should reject fewer than 3 outline bullets
      ‚úì should trim whitespace from all fields

PASS tests/scaffold/BugRegression.test.ts
  Bug Regression Verification
    ‚úì Fix 1: LLM Prompt should NOT force visual referencing (preventing Museum Guide style)
    ‚úì Fix 2: Voice should be configured to Fish Audio (User Preference)
    ‚úì Fix 3: Orchestrator should upload to Cloudinary and Delay (preventing Shotstack download error)
    ‚úì Fix 4: Make.com Callback should include permanent video_url
    ‚úì Fix 5: Final Video should have propagation delay
    ‚úì Fix 6: Image Policy should be strict (Heterosexual)
    ‚úì Fix 7: Background Music Volume should be low (0.1) (1 ms)
    ‚úì Fix 8: Subtitles should be readable (Size 48, Margin 350)
    ‚úì Fix 9: Images should be Vertical (9:16 Prompt)
    ‚úì Fix 10: Parable mode should NOT overwrite segment count after hook optimization
    ‚úì Fix 11: Commentary should be 95-100% of video length
    ‚úì Fix 12: HookPlan should NOT override enforced segment count

PASS tests/unit/application/ParableImageMode.test.ts
  Parable Image Mode Acceptance Criteria
    AC1: Parable Detection
      ‚úì forceMode: "parable" should set contentMode to parable (1 ms)
      ‚úì forceMode: undefined should default to direct-message
    AC2: Image Mode Enforcement
      ‚úì parable content should NEVER use animated mode
      ‚úì non-parable content can use animated mode
    AC3: Beat-to-Image Mapping
      ‚úì should have 4 beats with imagePrompts
      ‚úì each beat imagePrompt should include style prefix
      ‚úì turn beat should have DARKER in imagePrompt
      ‚úì moral beat should have BRIGHTER in imagePrompt
    AC4: Duration Accuracy
      ‚úì total duration should be 36-46 seconds
      ‚úì each beat should have valid duration (1 ms)
      ‚úì hook should be 8-10 seconds
      ‚úì setup should be 10-14 seconds
    AC5: Ken Burns Effect
      ‚úì Shotstack should apply zoomIn effect to images
      ‚úì first image should have fade-in transition
    AC6: Voiceover Sync
      ‚úì voiceover text should include all beat narrations
      ‚úì voiceover duration should match total beat duration
    Edge Cases
      ‚úì should handle empty beats array gracefully
      ‚úì should handle missing imagePrompt
      ‚úì should handle very short narration
      ‚úì should handle very long narration

PASS tests/unit/domain/Parable.test.ts
  Parable Domain Entities
    ContentMode type
      ‚úì should accept "direct-message" as valid ContentMode
      ‚úì should accept "parable" as valid ContentMode
    ForceMode type
      ‚úì should accept "direct" as valid ForceMode
      ‚úì should accept "parable" as valid ForceMode
    ParableCulture type
      ‚úì should accept all valid cultures
    ParableArchetype type
      ‚úì should accept all valid archetypes
    ParableIntent
      ‚úì should create a valid theme-only intent (1 ms)
      ‚úì should create a valid provided-story intent with cultural preference
      ‚úì should validate intent with type guard
    ParableSourceChoice
      ‚úì should create a valid source choice
    ParableBeat
      ‚úì should create valid beats for all roles
    ParableScriptPlan
      ‚úì should create a complete script plan
      ‚úì should validate script plan with type guard

PASS tests/unit/PersonalCloneFeatureFlags.test.ts
  Personal Clone Feature Flags
    ‚úì Config should include Personal Clone feature flags
    ‚úì Feature flags should default to false (non-breaking) (1 ms)
    ‚úì Config should include Personal Clone server URLs
  TrainingDataCollector
    ‚úì TrainingDataCollector should exist
    ‚úì TrainingDataCollector should have voice sample collection
    ‚úì TrainingDataCollector should have text sample collection
    ‚úì TrainingDataCollector should support export for XTTS
    ‚úì TrainingDataCollector should support export for LLM

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/unit/domain/CommentaryPrecision.test.ts
  Commentary Precision Requirements
    ‚úì should stay within 95-100% video length (100% case) (1 ms)
    ‚úì should flag "shorter" if even 1% over (101% case)
    ‚úì should stay "ok" at 96% video length
    ‚úì should flag "longer" if below 95% (94% case)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/unit/ConfigLoader.test.ts
  ConfigLoader Resilience
    ‚úì should strip double quotes from environment variables
    ‚úì should strip single quotes from environment variables (1 ms)
    ‚úì should trim whitespace from environment variables
    ‚úì should handle numeric variables with quotes
    ‚úì should correctly load custom callback headers even with quotes

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    2. Testing extractParableIntent with sample transcript...

      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:128:13)

FAIL tests/integration/ParableCaptionLive.test.ts
  ‚óè Test suite failed to run

    Your test suite must contain at least one test.

      at onResult (node_modules/@jest/core/build/index.js:1057:18)
      at node_modules/@jest/core/build/index.js:1127:165
      at node_modules/emittery/index.js:363:13
          at Array.map (<anonymous>)
      at Emittery.emit (node_modules/emittery/index.js:361:23)

  console.log
    [dotenv@17.2.3] injecting env (34) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [Shotstack] Render started: f05ab39a-82ea-440c-b0aa-c48b43400d29

      at ShortstackVideoRenderer.startRender (src/infrastructure/video/ShortstackVideoRenderer.ts:334:21)

  console.log
    Generating images for 1 segments...

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:862:17)

  console.log
    [job-123] generating_images: Creating visual 1 of 1...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.warn
    Primary image client failed for segment 0, falling back to secondary client: TypeError: this.deps.jobManager.updateStatus is not a function
        at ReelOrchestrator.updateJobStatus (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:956:30)
        at ReelOrchestrator.generateImages (/Users/user1000/gitprojects/InstagramReelPoster/src/application/ReelOrchestrator.ts:880:36)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/application/ReelOrchestrator.test.ts:303:34)
        at Promise.finally.completed (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1497:10)
        at _callCircusTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1007:40)
        at _runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:947:3)
        at /Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at _runTestsForDescribeBlock (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:857:11)
        at run (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/jestAdapterInit.js:1918:21)
        at jestAdapter (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:275:16)
        at runTest (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:343:7)
        at Object.worker (/Users/user1000/gitprojects/InstagramReelPoster/node_modules/jest-runner/build/testWorker.js:497:12)

      882 |                         finalImageUrl = imageUrl;
      883 |                     } catch (primaryError) {
    > 884 |                         console.warn(`Primary image client failed for segment ${index}, falling back to secondary client:`, primaryError);
          |                                 ^
      885 |                         const { imageUrl } = await this.deps.fallbackImageClient.generateImage(segment.imagePrompt);
      886 |                         finalImageUrl = imageUrl;
      887 |                     }

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:884:33)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.test.ts:303:34)

  console.log
    Waiting 2s for asset propagation...

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:919:21)

  console.log
    [Integration] Received response.

      at Object.<anonymous> (tests/integration/FishAudioLive.test.ts:29:17)

  console.log
    [Integration] Success: Received Base64 Audio Data

      at Object.<anonymous> (tests/integration/FishAudioLive.test.ts:39:21)

  console.log
    [Integration] Estimated/Actual Duration: 4.76s

      at Object.<anonymous> (tests/integration/FishAudioLive.test.ts:45:21)

PASS tests/integration/FishAudioLive.test.ts
  Fish Audio Live Integration
    ‚úì Should successfully synthesize audio from Fish Audio API (2353 ms)

  console.log
    [Shotstack] Render f05ab39a-82ea-440c-b0aa-c48b43400d29 status: failed

      at ShortstackVideoRenderer.pollForCompletion (src/infrastructure/video/ShortstackVideoRenderer.ts:364:25)

  console.log
    [Test] Error Details: Shotstack render failed: Downloading assets failed: Asset URL not downloadable (403): https://shotstack-assets.s3.ap-southeast-2.amazonaws.com/captions/subtitles.srt

      at Object.<anonymous> (tests/integration/ShotstackPayload.test.ts:41:21)

  console.warn
    [DALL-E] Transient error (429), retrying in 4.462s (Attempt 2/5)...

      73 |                         const delay = baseDelay + jitter;
      74 |
    > 75 |                         console.warn(`[DALL-E] Transient error (${status}), retrying in ${delay / 1000}s (Attempt ${attempt + 1}/${this.maxRetries})...`);
         |                                 ^
      76 |                         await this.sleep(delay);
      77 |                         continue;
      78 |                     }

      at OpenAIImageClient.generateImage (src/infrastructure/images/OpenAIImageClient.ts:75:33)
      at Object.<anonymous> (tests/unit/infrastructure/OpenAIImageClient.test.ts:125:13)

  console.log
    ‚úÖ PASS: Payload was accepted (Render failed later, likely due to asset issues, but schema is valid)

      at Object.<anonymous> (tests/integration/ShotstackPayload.test.ts:53:25)

PASS tests/integration/ShotstackPayload.test.ts
  Shotstack Payload Validation (Live)
    ‚úì Should successfully SUBMIT a render job (Payload Validity Check) (2382 ms)

  console.log
    [Fish Audio] Synthesizing with voice ID: test-voice

      at FishAudioTTSClient.synthesize (src/infrastructure/tts/FishAudioTTSClient.ts:34:21)

(node:26961) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/chaos/chaos.test.ts
  Chaos Tests - API Failure Scenarios
    API Timeout Handling
      ‚úì should timeout gracefully when OpenAI takes too long (245 ms)
    Malformed Response Handling
      ‚úì should handle LLM returning HTML instead of JSON (24 ms)
      ‚úì should handle LLM returning empty response (8 ms)
      ‚úì should handle LLM returning truncated JSON (4 ms)
    Rate Limit Handling
      ‚úï should throw on 429 from OpenAI (2695 ms)
    Invalid Credentials
      ‚úï should throw clear error on 401 Unauthorized (6 ms)
    Content Policy Violations
      ‚úì should throw clear error when content is rejected (8 ms)
  Chaos Tests - Data Edge Cases
    Extreme Input Values
      ‚úì should handle very long text in TTS (7 ms)
      ‚úì should handle Unicode characters in prompts (5 ms)

  ‚óè Chaos Tests - API Failure Scenarios ‚Ä∫ Rate Limit Handling ‚Ä∫ should throw on 429 from OpenAI

    expect(received).rejects.toThrow(expected)

    Expected substring: "LLM call failed"
    Received message:   "OpenAI call failed: Nock: No match for request {
      \"method\": \"POST\",
      \"url\": \"https://api.openai.com/v1/chat/completions\",
      \"headers\": {
        \"accept\": \"application/json, text/plain, */*\",
        \"accept-encoding\": \"gzip, compress, deflate, br\",
        \"authorization\": \"Bearer test-key\",
        \"connection\": \"close\",
        \"content-length\": \"2142\",
        \"content-type\": \"application/json\",
        \"user-agent\": \"axios/1.13.2\"
      },
      \"body\": \"{\\\"model\\\":\\\"gpt-4o\\\",\\\"messages\\\":[{\\\"role\\\":\\\"system\\\",\\\"content\\\":\\\"You are the creative mind behind \\\\\\\"Challenging View,\\\\\\\" an Instagram channel that uses spiritual psychology and caustic ancient wisdom to expose modern self-deception.\\\\n\\\\nVOICE AND PERSONALITY:\\\\n- Tone: Direct, grounded, spiritually perspicacious, unapologetic.\\\\n- Background: A mix of Indian cultural roots and Californian psychological directness.\\\\n- Philosophy: Truth is often uncomfortable; your job is to deliver it with surgical precision.\\\\n- Style: Pattern-breaking. You stop the scroll by saying what others are too polite or too deluded to say.\\\\n\\\\nWRITING GUIDELINES:\\\\n1. NO FLUFF: Avoid introductory filler (\\\\\\\"In this video,\\\\\\\" \\\\\\\"So,\\\\\\\" \\\\\\\"Hey guys\\\\\\\"). Start with the punch.\\\\n2. CONSTRUCTIVE CAUSTICITY: Be sharp, but the goal is always deeper self-awareness, not just being mean.\\\\n3. GROUNDED SPIRITUALITY: Use terms like \\\\\\\"shadow work,\\\\\\\" \\\\\\\"projection,\\\\\\\" \\\\\\\"bypass,\\\\\\\" and \\\\\\\"ego mechanics.\\\\\\\" Avoid \\\\\\\"love and light\\\\\\\" or generic wellness clich√©s.\\\\n4. MICRO-DOSE INSIGHT: Every sentence must earned its place. If it doesn't challenge or reveal, cut it.\\\\n5. CULTURAL FUSION: Subtly weave in Vedantic or Zen concepts without being \\\\\\\"yoga-teacher-y.\\\\\\\"\\\\n\\\\nIMAGE STYLE:\\\\n- Aesthetic: Muted, cinematic, grounded, slightly dark but clear.\\\\n- Preference for high-contrast, moody lighting.\\\\n- Focus on symbolic objects or minimalist environments that mirror the psychological state.\\\"},{\\\"role\\\":\\\"user\\\",\\\"content\\\":\\\"Plan an Instagram Reel structure based on this transcript.\\\\n\\\\nTranscript: \\\\\\\"test\\\\\\\"\\\\nConstraints: 10s to 15s\\\\n\\\\nTASK:\\\\n1. Extract the core psychological insight.\\\\n2. Determine the optimal total duration (within constraints).\\\\n3. Calculate the number of segments (aim for 5-8s per segment).\\\\n4. Determine the overall mood (e.g., \\\\\\\"Dark/Grounded\\\\\\\", \\\\\\\"Cinematic/Epic\\\\\\\", \\\\\\\"Minimalist/Meditative\\\\\\\").\\\\n\\\\nRespond with a JSON object:\\\\n{\\\\n  \\\\\\\"summary\\\\\\\": \\\\\\\"One sentence summary of the core insight\\\\\\\",\\\\n  \\\\\\\"mood\\\\\\\": \\\\\\\"overall visual mood\\\\\\\",\\\\n  \\\\\\\"targetDurationSeconds\\\\\\\": total_seconds,\\\\n  \\\\\\\"segmentCount\\\\\\\": number_of_segments\\\\n}\\\"}],\\\"temperature\\\":0.7,\\\"response_format\\\":{\\\"type\\\":\\\"json_object\\\"}}\"
    }"

          94 |         }
          95 |
        > 96 |         throw new Error(`OpenAI call failed: ${message}`);
             |               ^
          97 |     }
          98 |
          99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:36:26)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:104:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:105:26)

  ‚óè Chaos Tests - API Failure Scenarios ‚Ä∫ Invalid Credentials ‚Ä∫ should throw clear error on 401 Unauthorized

    expect(received).rejects.toThrow(expected)

    Expected substring: "LLM call failed: Invalid API key"
    Received message:   "OpenAI call failed: Invalid API key"

          94 |         }
          95 |
        > 96 |         throw new Error(`OpenAI call failed: ${message}`);
             |               ^
          97 |     }
          98 |
          99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:36:26)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:118:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:119:26)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "EXTRACTED INTENT:".

      142 |         const intent = await client.extractParableIntent(sampleTranscript);
      143 |
    > 144 |         console.log('EXTRACTED INTENT:');
          |                 ^
      145 |         console.log(JSON.stringify(intent, null, 2));
      146 |         console.log('\n');
      147 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:144:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "{
      "sourceType": "provided-story",
      "coreTheme": "discipline, atomic habits, perseverance without recognition",
      "moral": "Those who quietly and consistently compound their efforts often surpass those with every advantage. Silent, unrecognized practice can lead to greatness.",
      "culturalPreference": "indian",
      "constraints": [],
      "providedStoryContext": "The user describes a parable about Ekalavya from Indian history‚Äîa tribal boy who could not get a teacher, but practiced archery alone in the forest daily. He shot arrows at a clay statue of Dronacharya, his imaginary teacher. Despite receiving no recognition or validation, Ekalavya's daily practice made him better than the royal princes, who had all advantages. The characters mentioned are Ekalavya and Dronacharya. The story highlights small daily practice, lack of external acknowledgment, and eventual mastery."
    }".

      143 |
      144 |         console.log('EXTRACTED INTENT:');
    > 145 |         console.log(JSON.stringify(intent, null, 2));
          |                 ^
      146 |         console.log('\n');
      147 |
      148 |         console.log('VALIDATION:');

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:145:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "
    ".

      144 |         console.log('EXTRACTED INTENT:');
      145 |         console.log(JSON.stringify(intent, null, 2));
    > 146 |         console.log('\n');
          |                 ^
      147 |
      148 |         console.log('VALIDATION:');
      149 |         console.log(`  - sourceType: ${intent.sourceType} (should be provided-story)`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:146:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "VALIDATION:".

      146 |         console.log('\n');
      147 |
    > 148 |         console.log('VALIDATION:');
          |                 ^
      149 |         console.log(`  - sourceType: ${intent.sourceType} (should be provided-story)`);
      150 |         console.log(`  - coreTheme: ${intent.coreTheme}`);
      151 |         console.log(`  - moral: ${intent.moral}`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:148:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - sourceType: provided-story (should be provided-story)".

      147 |
      148 |         console.log('VALIDATION:');
    > 149 |         console.log(`  - sourceType: ${intent.sourceType} (should be provided-story)`);
          |                 ^
      150 |         console.log(`  - coreTheme: ${intent.coreTheme}`);
      151 |         console.log(`  - moral: ${intent.moral}`);
      152 |         console.log(`  - culturalPreference: ${intent.culturalPreference}`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:149:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - coreTheme: discipline, atomic habits, perseverance without recognition".

      148 |         console.log('VALIDATION:');
      149 |         console.log(`  - sourceType: ${intent.sourceType} (should be provided-story)`);
    > 150 |         console.log(`  - coreTheme: ${intent.coreTheme}`);
          |                 ^
      151 |         console.log(`  - moral: ${intent.moral}`);
      152 |         console.log(`  - culturalPreference: ${intent.culturalPreference}`);
      153 |         console.log(`  - providedStoryContext includes Ekalavya: ${intent.providedStoryContext?.includes('Ekalavya')}`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:150:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - moral: Those who quietly and consistently compound their efforts often surpass those with every advantage. Silent, unrecognized practice can lead to greatness.".

      149 |         console.log(`  - sourceType: ${intent.sourceType} (should be provided-story)`);
      150 |         console.log(`  - coreTheme: ${intent.coreTheme}`);
    > 151 |         console.log(`  - moral: ${intent.moral}`);
          |                 ^
      152 |         console.log(`  - culturalPreference: ${intent.culturalPreference}`);
      153 |         console.log(`  - providedStoryContext includes Ekalavya: ${intent.providedStoryContext?.includes('Ekalavya')}`);
      154 |         console.log(`  - providedStoryContext includes Dronacharya: ${intent.providedStoryContext?.includes('Dronacharya')}`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:151:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - culturalPreference: indian".

      150 |         console.log(`  - coreTheme: ${intent.coreTheme}`);
      151 |         console.log(`  - moral: ${intent.moral}`);
    > 152 |         console.log(`  - culturalPreference: ${intent.culturalPreference}`);
          |                 ^
      153 |         console.log(`  - providedStoryContext includes Ekalavya: ${intent.providedStoryContext?.includes('Ekalavya')}`);
      154 |         console.log(`  - providedStoryContext includes Dronacharya: ${intent.providedStoryContext?.includes('Dronacharya')}`);
      155 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:152:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - providedStoryContext includes Ekalavya: true".

      151 |         console.log(`  - moral: ${intent.moral}`);
      152 |         console.log(`  - culturalPreference: ${intent.culturalPreference}`);
    > 153 |         console.log(`  - providedStoryContext includes Ekalavya: ${intent.providedStoryContext?.includes('Ekalavya')}`);
          |                 ^
      154 |         console.log(`  - providedStoryContext includes Dronacharya: ${intent.providedStoryContext?.includes('Dronacharya')}`);
      155 |
      156 |         // Assertions

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:153:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - providedStoryContext includes Dronacharya: true".

      152 |         console.log(`  - culturalPreference: ${intent.culturalPreference}`);
      153 |         console.log(`  - providedStoryContext includes Ekalavya: ${intent.providedStoryContext?.includes('Ekalavya')}`);
    > 154 |         console.log(`  - providedStoryContext includes Dronacharya: ${intent.providedStoryContext?.includes('Dronacharya')}`);
          |                 ^
      155 |
      156 |         // Assertions
      157 |         if (intent.sourceType !== 'provided-story') {

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:154:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "
    ‚úÖ INTENT EXTRACTION PASSED!
    ".

      164 |         }
      165 |
    > 166 |         console.log('\n‚úÖ INTENT EXTRACTION PASSED!\n');
          |                 ^
      167 |
      168 |     } catch (error) {
      169 |         console.error('‚ùå ERROR during intent extraction:', error);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testExtractParableIntent (tests/integration/ParableCaptionLive.test.ts:166:17)
      at main (tests/integration/ParableCaptionLive.test.ts:175:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "=== PARABLE CAPTION & HASHTAG LIVE TEST ===
    ".

      71 |
      72 | async function testCaptionGeneration() {
    > 73 |     console.log('=== PARABLE CAPTION & HASHTAG LIVE TEST ===\n');
         |             ^
      74 |
      75 |     const client = new OpenAILLMClient(OPENAI_API_KEY!);
      76 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:73:13)
      at main (tests/integration/ParableCaptionLive.test.ts:176:11)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "1. Testing generateParableCaptionAndTags...
    ".

      75 |     const client = new OpenAILLMClient(OPENAI_API_KEY!);
      76 |
    > 77 |     console.log('1. Testing generateParableCaptionAndTags...\n');
         |             ^
      78 |
      79 |     try {
      80 |         const result = await client.generateParableCaptionAndTags(

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:77:13)
      at main (tests/integration/ParableCaptionLive.test.ts:176:11)

PASS tests/unit/application/ReelOrchestrator.test.ts
  ReelOrchestrator
    validateSegmentCount
      ‚úì should throw if segments is not an array (22 ms)
      ‚úì should throw if segment count does not match expected (1 ms)
      ‚úì should throw if a segment has empty commentary
      ‚úì should throw if a segment has very short commentary (1 ms)
      ‚úì should pass for valid segments matching expected count
    buildSegments
      ‚úì should create segments with proper timing distribution (1 ms)
      ‚úì should distribute duration equally among segments (1 ms)
      ‚úì should include commentary and imagePrompt in segments
    getFriendlyErrorMessage
      ‚úì should return transcription message for transcribe errors
      ‚úì should return API message for OpenAI errors (2 ms)
      ‚úì should return music message for track errors
      ‚úì should return image message for DALL-E errors
      ‚úì should return render message for video errors (1 ms)
      ‚úì should return duration message for too short/long errors
      ‚úì should return generic message for unknown errors (1 ms)
    synthesizeWithAdjustment
      ‚úì should synthesize voiceover with TTS client (7 ms)
      ‚úì should fall back to secondary TTS if primary fails (3 ms)
    generateImages
      ‚úì should generate images for all segments (2008 ms)
      ‚úì should use fallback image client if primary fails (2010 ms)

  console.log
    [Memory] Start processJob: 57.73 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] transcribing: Transcribing voice note...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 1: Transcription: 61.88 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] TRANSCRIPT: "Test transcription requiring animation"

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:115:21)

  console.log
    [job-animated-123] detecting_intent: Analyzing request for animation...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Reel Mode: IMAGES

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:142:25)

  console.log
    [job-animated-123] planning: Planning reel structure...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Planning reel with range: 30s - 60s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:209:21)

  console.log
    [job-animated-123] LLM Initial Plan: target=45s, segments=3

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:289:21)

  console.log
    [Memory] Step 2: Planning: 62.58 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] generating_commentary: Writing commentary...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] synthesizing_voiceover: Creating voiceover...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [TTS] Attempting synthesis with primary client (Fish Audio)...

      at ReelOrchestrator.synthesizeWithAdjustment (src/application/ReelOrchestrator.ts:777:21)

  console.log
    [job-animated-123] Voiceover generated: duration=45s

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:371:25)

  console.log
    [Memory] Steps 3-5: Content & Voiceover: 63.48 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] Caption Debug: jobAfterSegments=true, captionBody=false, hashtags=0, contentMode=direct-message, hasParableScript=false

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:390:21)

  console.warn
    [job-animated-123] Caption NOT generated: contentMode=direct-message, hasParableScript=false, hasCaptionService=false

      430 |                     } else {
      431 |                         // DEBUG: Log why caption was not generated
    > 432 |                         console.warn(`[${jobId}] Caption NOT generated: contentMode=${contentMode}, hasParableScript=${!!parableScriptPlan}, hasCaptionService=${!!this.deps.captionService}`);
          |                                 ^
      433 |                     }
      434 |                 } catch (err) {
      435 |                     console.warn(`[${jobId}] Caption optimization failed:`, err);

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:432:33)
      at Object.<anonymous> (tests/unit/application/ReelOrchestrator.animatedVideo.test.ts:175:9)

  console.log
    [job-animated-123] selecting_music: Finding background music...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 6: Music: 65.06 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] generating_images: Creating visuals...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    Generating images for 3 segments...

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:862:17)

  console.log
    [job-animated-123] generating_images: Creating visual 1 of 3...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] generating_images: Creating visual 2 of 3...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] generating_images: Creating visual 3 of 3...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    Waiting 2s for asset propagation...

      at ReelOrchestrator.generateImages (src/application/ReelOrchestrator.ts:919:21)

(node:26958) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/unit/infrastructure/OpenAIImageClient.test.ts (6.871 s)
  OpenAIImageClient
    Constructor validation
      ‚úì should throw error when API key is missing (9 ms)
      ‚úì should create client with valid API key
    generateImage() - Input validation
      ‚úì should throw error for empty prompt (1 ms)
      ‚úì should throw error for whitespace-only prompt
    generateImage() - Success cases
      ‚úì should return image URL from DALL-E 3 response (39 ms)
      ‚úì should enhance prompt with cinematic style (5 ms)
      ‚úì should use DALL-E 3 as the model (6 ms)
    generateImage() - Error handling
      ‚úì should throw descriptive error on content policy violation (76 ms)
      ‚úï should handle 429 rate limit after retries (5001 ms)
      ‚úì should handle 500 server error (5 ms)
      ‚úì should handle network errors (7 ms)
    generateImage() - Options
      ‚úì should use default size if not specified (4 ms)
      ‚úì should use custom size when provided (4 ms)

  ‚óè OpenAIImageClient ‚Ä∫ generateImage() - Error handling ‚Ä∫ should handle 429 rate limit after retries

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      112 |         });
      113 |
    > 114 |         it('should handle 429 rate limit after retries', async () => {
          |         ^
      115 |             const client = new OpenAIImageClient(apiKey, baseUrl);
      116 |
      117 |             // Mock 3 consecutive 429 errors (maxRetries = 3)

      at tests/unit/infrastructure/OpenAIImageClient.test.ts:114:9
      at tests/unit/infrastructure/OpenAIImageClient.test.ts:97:5
      at Object.<anonymous> (tests/unit/infrastructure/OpenAIImageClient.test.ts:4:1)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "CAPTION BODY:".

      83 |         );
      84 |
    > 85 |         console.log('CAPTION BODY:');
         |                 ^
      86 |         console.log('---');
      87 |         console.log(result.captionBody);
      88 |         console.log('---\n');

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:85:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "---".

      84 |
      85 |         console.log('CAPTION BODY:');
    > 86 |         console.log('---');
         |                 ^
      87 |         console.log(result.captionBody);
      88 |         console.log('---\n');
      89 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:86:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "This is the story of what really happens when a student quietly builds their discipline, one small habit at a time.

    While others chase shortcuts and talk big, the humble ones stack invisible victories‚Äîuntil one day, their quiet work leaves everyone else behind. 

    Sound familiar? Save this for the next time you wonder if your tiny efforts matter.".

      85 |         console.log('CAPTION BODY:');
      86 |         console.log('---');
    > 87 |         console.log(result.captionBody);
         |                 ^
      88 |         console.log('---\n');
      89 |
      90 |         console.log('HASHTAGS:');

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:87:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "---
    ".

      86 |         console.log('---');
      87 |         console.log(result.captionBody);
    > 88 |         console.log('---\n');
         |                 ^
      89 |
      90 |         console.log('HASHTAGS:');
      91 |         console.log('---');

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:88:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "HASHTAGS:".

      88 |         console.log('---\n');
      89 |
    > 90 |         console.log('HASHTAGS:');
         |                 ^
      91 |         console.log('---');
      92 |         console.log(result.hashtags);
      93 |         console.log('---\n');

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:90:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "---".

      89 |
      90 |         console.log('HASHTAGS:');
    > 91 |         console.log('---');
         |                 ^
      92 |         console.log(result.hashtags);
      93 |         console.log('---\n');
      94 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:91:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "[
      '#shadowwork',
      '#selfinquiry',
      '#egodeath',
      '#spiritualpsychology',
      '#projection',
      '#spirituality',
      '#mindfulness',
      '#reels',
      '#wisdom',
      '#growth',
      '#ChallengingView',
      '#parables',
      '#spiritualstorytelling'
    ]".

      90 |         console.log('HASHTAGS:');
      91 |         console.log('---');
    > 92 |         console.log(result.hashtags);
         |                 ^
      93 |         console.log('---\n');
      94 |
      95 |         console.log('VALIDATION:');

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:92:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "---
    ".

      91 |         console.log('---');
      92 |         console.log(result.hashtags);
    > 93 |         console.log('---\n');
         |                 ^
      94 |
      95 |         console.log('VALIDATION:');
      96 |         console.log(`  - Caption length: ${result.captionBody.length} chars (should be > 20)`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:93:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "VALIDATION:".

      93 |         console.log('---\n');
      94 |
    > 95 |         console.log('VALIDATION:');
         |                 ^
      96 |         console.log(`  - Caption length: ${result.captionBody.length} chars (should be > 20)`);
      97 |         console.log(`  - Hashtag count: ${result.hashtags.length} (should be >= 8)`);
      98 |         console.log(`  - Has #ChallengingView: ${result.hashtags.includes('#ChallengingView')}`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:95:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - Caption length: 348 chars (should be > 20)".

      94 |
      95 |         console.log('VALIDATION:');
    > 96 |         console.log(`  - Caption length: ${result.captionBody.length} chars (should be > 20)`);
         |                 ^
      97 |         console.log(`  - Hashtag count: ${result.hashtags.length} (should be >= 8)`);
      98 |         console.log(`  - Has #ChallengingView: ${result.hashtags.includes('#ChallengingView')}`);
      99 |         console.log(`  - All start with #: ${result.hashtags.every(t => t.startsWith('#'))}`);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:96:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - Hashtag count: 13 (should be >= 8)".

       95 |         console.log('VALIDATION:');
       96 |         console.log(`  - Caption length: ${result.captionBody.length} chars (should be > 20)`);
    >  97 |         console.log(`  - Hashtag count: ${result.hashtags.length} (should be >= 8)`);
          |                 ^
       98 |         console.log(`  - Has #ChallengingView: ${result.hashtags.includes('#ChallengingView')}`);
       99 |         console.log(`  - All start with #: ${result.hashtags.every(t => t.startsWith('#'))}`);
      100 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:97:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - Has #ChallengingView: true".

       96 |         console.log(`  - Caption length: ${result.captionBody.length} chars (should be > 20)`);
       97 |         console.log(`  - Hashtag count: ${result.hashtags.length} (should be >= 8)`);
    >  98 |         console.log(`  - Has #ChallengingView: ${result.hashtags.includes('#ChallengingView')}`);
          |                 ^
       99 |         console.log(`  - All start with #: ${result.hashtags.every(t => t.startsWith('#'))}`);
      100 |
      101 |         // Assertions

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:98:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "  - All start with #: true".

       97 |         console.log(`  - Hashtag count: ${result.hashtags.length} (should be >= 8)`);
       98 |         console.log(`  - Has #ChallengingView: ${result.hashtags.includes('#ChallengingView')}`);
    >  99 |         console.log(`  - All start with #: ${result.hashtags.every(t => t.startsWith('#'))}`);
          |                 ^
      100 |
      101 |         // Assertions
      102 |         if (result.captionBody.length < 20) {

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:99:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "
    ‚úÖ ALL VALIDATIONS PASSED!
    ".

      117 |         }
      118 |
    > 119 |         console.log('\n‚úÖ ALL VALIDATIONS PASSED!\n');
          |                 ^
      120 |
      121 |     } catch (error) {
      122 |         console.error('‚ùå ERROR during caption generation:', error);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at testCaptionGeneration (tests/integration/ParableCaptionLive.test.ts:119:17)
      at main (tests/integration/ParableCaptionLive.test.ts:176:5)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "=== ALL LIVE TESTS PASSED ===".

      175 |     await testExtractParableIntent();
      176 |     await testCaptionGeneration();
    > 177 |     console.log('=== ALL LIVE TESTS PASSED ===');
          |             ^
      178 | }
      179 |
      180 | main().catch(console.error);

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at main (tests/integration/ParableCaptionLive.test.ts:177:13)

  console.warn
    [LLM] Reel mode detection failed, defaulting to image mode: Error: Failed to parse LLM response as JSON: not valid json...
        at OpenAIService.parseJSON (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAIService.ts:112:19)
        at OpenAILLMClient.detectReelMode (/Users/user1000/gitprojects/InstagramReelPoster/src/infrastructure/llm/OpenAILLMClient.ts:61:47)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at Object.<anonymous> (/Users/user1000/gitprojects/InstagramReelPoster/tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:146:28)

      69 |             };
      70 |         } catch (error) {
    > 71 |             console.warn('[LLM] Reel mode detection failed, defaulting to image mode:', error);
         |                     ^
      72 |             return {
      73 |                 isAnimatedMode: false,
      74 |                 reason: 'Detection failed, defaulting to image-based reel',

      at OpenAILLMClient.detectReelMode (src/infrastructure/llm/OpenAILLMClient.ts:71:21)
      at Object.<anonymous> (tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:146:28)

FAIL tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts (5.073 s)
  OpenAILLMClient.detectReelMode
    Animated mode detection
      ‚úì should return isAnimatedMode: true when transcript mentions "animated video" (5 ms)
      ‚úì should return isAnimatedMode: true when transcript mentions "animation" (4 ms)
      ‚úì should return isAnimatedMode: true when transcript mentions "moving visuals" (4 ms)
    Default to images
      ‚úì should return isAnimatedMode: false for normal transcripts (default) (6 ms)
      ‚úì should return isAnimatedMode: false for empty transcript
      ‚úì should return isAnimatedMode: false for whitespace-only transcript (1 ms)
    Storyline extraction
      ‚úì should extract storyline when user provides one (4 ms)
      ‚úì should not include storyline when user does not provide one (3 ms)
    Error handling
      ‚úï should handle API errors gracefully and default to image mode (5003 ms)
      ‚úì should handle malformed JSON response gracefully (16 ms)

  ‚óè OpenAILLMClient.detectReelMode ‚Ä∫ Error handling ‚Ä∫ should handle API errors gracefully and default to image mode

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      122 |
      123 |     describe('Error handling', () => {
    > 124 |         it('should handle API errors gracefully and default to image mode', async () => {
          |         ^
      125 |             nock('https://api.openai.com')
      126 |                 .post('/v1/chat/completions')
      127 |                 .replyWithError('Network error');

      at tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:124:9
      at tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:123:5
      at Object.<anonymous> (tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:5:1)

  ‚óè OpenAILLMClient.detectReelMode ‚Ä∫ Error handling ‚Ä∫ should handle API errors gracefully and default to image mode




  ‚óè OpenAILLMClient.detectReelMode ‚Ä∫ Error handling ‚Ä∫ should handle API errors gracefully and default to image mode




  console.log
    [Memory] Step 7: Images: 66.56 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] generating_subtitles: Creating subtitles...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Step 8: Subtitles: 66.81 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] building_manifest: Preparing render manifest...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] rendering: Rendering final video...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [Memory] Starting Step 10: Rendering: 67.2 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [Memory] Step 10: Finished Rendering: 67.39 MB

      at ReelOrchestrator.logMemoryUsage (src/application/ReelOrchestrator.ts:83:17)

  console.log
    [job-animated-123] uploading: Uploading to permanent storage...

      at ReelOrchestrator.updateJobStatus (src/application/ReelOrchestrator.ts:955:17)

  console.log
    [job-animated-123] Uploading final video to Cloudinary for permanent storage...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:643:29)

  console.log
    [job-animated-123] Video uploaded successfully: https://cloudinary.com/persisted_anim.mp4

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:650:29)

  console.log
    [job-animated-123] Waiting 5s for final video propagation...

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:654:29)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "[ReelPlan] Overriding LLM segment count undefined with calculated 3".

      43 |
      44 |         if (plan.segmentCount !== enforcedSegmentCount) {
    > 45 |             console.log(`[ReelPlan] Overriding LLM segment count ${plan.segmentCount} with calculated ${enforcedSegmentCount}`);
         |                     ^
      46 |             plan.segmentCount = enforcedSegmentCount;
      47 |         }
      48 |

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:45:21)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "[ReelPlan] Targeted undefineds with 3 segments.".

      51 |         if (plan.segmentCount > 15) plan.segmentCount = 15;
      52 |
    > 53 |         console.log(`[ReelPlan] Targeted ${plan.targetDurationSeconds}s with ${plan.segmentCount} segments.`);
         |                 ^
      54 |
      55 |         return plan;
      56 |     }

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:53:17)

PASS tests/unit/application/ReelOrchestrator.animatedVideo.test.ts (12.042 s)
  ReelOrchestrator - Animated Video Flow
    ‚úì should detect animated video intent and update job with persisted video (5016 ms)
    ‚úì should fall back to image generation if detectReelMode returns false (7010 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL tests/unit/application/ReelPersonalCloneIntegration.test.ts
  ‚óè ReelOrchestrator - Personal Clone Integration ‚Ä∫ should collect voice samples and text samples during processJob when training mode is on

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Segment 1", "commentary"

    Number of calls: 0

      80 |         );
      81 |
    > 82 |         expect(collectTextSpy).toHaveBeenCalledWith('Segment 1', 'commentary');
         |                                ^
      83 |         expect(collectTextSpy).toHaveBeenCalledWith('Segment 2', 'commentary');
      84 |     });
      85 |

      at Object.<anonymous> (tests/unit/application/ReelPersonalCloneIntegration.test.ts:82:32)

FAIL tests/unit/domain/ReelJob.test.ts
  ‚óè ReelJob ‚Ä∫ createReelJob ‚Ä∫ should throw error for empty sourceAudioUrl

    expect(received).toThrow(expected)

    Expected substring: "ReelJob sourceAudioUrl cannot be empty"
    Received message:   "ReelJob requires either sourceAudioUrl or transcript"

          169 |
          170 |     if (!hasAudio && !hasTranscript) {
        > 171 |         throw new Error('ReelJob requires either sourceAudioUrl or transcript');
              |               ^
          172 |     }
          173 |
          174 |     const now = new Date();

      at createReelJob (src/domain/entities/ReelJob.ts:171:15)
      at tests/unit/domain/ReelJob.test.ts:68:39
      at Object.<anonymous> (node_modules/expect/build/index.js:1824:9)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:2235:93)
      at Object.<anonymous> (tests/unit/domain/ReelJob.test.ts:68:81)
      at Object.<anonymous> (tests/unit/domain/ReelJob.test.ts:68:81)

FAIL tests/unit/application/HookAndStructureService.test.ts
  ‚óè HookAndStructureService ‚Ä∫ should bias towards shorter duration (10-20s) for discovery

    expect(received).toBeLessThan(expected)

    Expected: < 60
    Received:   60

      50 |
      51 |         // Default discovery bias should clamp or reduce duration
    > 52 |         expect(result.targetDurationSeconds).toBeLessThan(60);
         |                                              ^
      53 |         expect(result.targetDurationSeconds).toBeGreaterThanOrEqual(10);
      54 |     });
      55 | });

      at Object.<anonymous> (tests/unit/application/HookAndStructureService.test.ts:52:46)

FAIL tests/unit/DurationRespect.test.ts
  ‚óè OpenAILLMClient Duration Logic ‚Ä∫ Should accept LLM-determined duration (e.g. 60s) when requested

    expect(received).toBe(expected) // Object.is equality

    Expected: 12
    Received: 10

      37 |
      38 |         expect(plan.targetDurationSeconds).toBe(60);
    > 39 |         expect(plan.segmentCount).toBe(12);
         |                                   ^
      40 |
      41 |         // Verify prompt logic
      42 |         const requestBody = mockedAxios.post.mock.calls[0][1] as any;

      at Object.<anonymous> (tests/unit/DurationRespect.test.ts:39:35)

  ‚óè OpenAILLMClient Duration Logic ‚Ä∫ Should clamp excessive segment counts to 15

    expect(received).toBe(expected) // Object.is equality

    Expected: 15
    Received: 10

      70 |
      71 |         // Assert strictly capped at 15
    > 72 |         expect(plan.segmentCount).toBe(15);
         |                                   ^
      73 |     });
      74 | });
      75 |

      at Object.<anonymous> (tests/unit/DurationRespect.test.ts:72:35)

FAIL tests/unit/LLMResilience.test.ts
  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should pass through a plain array

    TypeError: client.normalizeSegments is not a function

      13 |             { commentary: 'text 2', imagePrompt: 'prompt 2' }
      14 |         ];
    > 15 |         const result = client.normalizeSegments(input);
         |                               ^
      16 |         expect(result).toHaveLength(2);
      17 |         expect(result[0].commentary).toBe('text 1');
      18 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:15:31)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should unwrap an object containing a "segments" array

    TypeError: client.normalizeSegments is not a function

      25 |             ]
      26 |         };
    > 27 |         const result = client.normalizeSegments(input);
         |                               ^
      28 |         expect(result).toHaveLength(2);
      29 |         expect(result[0].commentary).toBe('text 1');
      30 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:27:31)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should wrap a single object into an array

    TypeError: client.normalizeSegments is not a function

      32 |     it('should wrap a single object into an array', () => {
      33 |         const input = { commentary: 'text 1', imagePrompt: 'prompt 1' };
    > 34 |         const result = client.normalizeSegments(input);
         |                               ^
      35 |         expect(result).toHaveLength(1);
      36 |         expect(result[0].commentary).toBe('text 1');
      37 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:34:31)

  ‚óè LLM Resilience - Segment Normalization ‚Ä∫ should handle numbered object keys (common LLM failure mode)

    TypeError: client.normalizeSegments is not a function

      42 |             "1": { commentary: 'text 2', imagePrompt: 'prompt 2' }
      43 |         };
    > 44 |         const result = client.normalizeSegments(input);
         |                               ^
      45 |         expect(result).toHaveLength(2);
      46 |         expect(result[0].commentary).toBe('text 1');
      47 |     });

      at Object.<anonymous> (tests/unit/LLMResilience.test.ts:44:31)

FAIL tests/unit/infrastructure/LocalLLMClient.test.ts
  ‚óè LocalLLMClient ‚Ä∫ error handling ‚Ä∫ should retry on transient errors (502, 503, 429)

    thrown: Object {
      "isAxiosError": true,
      "response": Object {
        "data": Object {
          "error": "Bad Gateway",
        },
        "status": 502,
      },
    }

      260 |
      261 |     describe('error handling', () => {
    > 262 |         test('should retry on transient errors (502, 503, 429)', async () => {
          |         ^
      263 |             const client = new LocalLLMClient('http://localhost:11434');
      264 |             const mockPlan = {
      265 |                 targetDurationSeconds: 30,

      at tests/unit/infrastructure/LocalLLMClient.test.ts:262:9
      at tests/unit/infrastructure/LocalLLMClient.test.ts:261:5
      at Object.<anonymous> (tests/unit/infrastructure/LocalLLMClient.test.ts:8:1)

  ‚óè LocalLLMClient ‚Ä∫ error handling ‚Ä∫ should throw on non-transient errors

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"mood": "test", "musicPrompt": "", "musicTags": [], "segmentCount": 6, "summary": "test", "targetDurationSeconds": 30}

      299 |             (axios.isAxiosError as unknown as jest.Mock) = jest.fn().mockReturnValue(true);
      300 |
    > 301 |             await expect(client.planReel('Test', { minDurationSeconds: 10, maxDurationSeconds: 90 }))
          |                   ^
      302 |                 .rejects.toThrow('Local LLM call failed');
      303 |         });
      304 |

      at expect (node_modules/expect/build/index.js:2116:15)
      at Object.<anonymous> (tests/unit/infrastructure/LocalLLMClient.test.ts:301:19)

  ‚óè LocalLLMClient ‚Ä∫ error handling ‚Ä∫ should throw on invalid JSON response

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to parse JSON"

    Received function did not throw

      311 |
      312 |             await expect(client.planReel('Test', { minDurationSeconds: 10, maxDurationSeconds: 90 }))
    > 313 |                 .rejects.toThrow('Failed to parse JSON');
          |                          ^
      314 |         });
      315 |     });
      316 | });

      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/infrastructure/LocalLLMClient.test.ts:313:26)

FAIL tests/unit/infrastructure/KieVideoClient.test.ts
  ‚óè KieVideoClient ‚Ä∫ generateAnimatedVideo ‚Ä∫ should create a task and poll until success

    Kie.ai API error undefined: Unknown error

      86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
      87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
    > 88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
         |                       ^
      89 |             }
      90 |
      91 |             const jobId = data.data?.taskId || data.taskId || data.id;

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:88:23)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:43:28)

  ‚óè KieVideoClient ‚Ä∫ generateAnimatedVideo ‚Ä∫ should throw error if production fails

    expect(received).rejects.toThrow(expected)

    Expected substring: "Kie.ai video generation failed: Content policy violation"
    Received message:   "Kie.ai API error undefined: Unknown error"

          86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
          87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
        > 88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
             |                       ^
          89 |             }
          90 |
          91 |             const jobId = data.data?.taskId || data.taskId || data.id;

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:88:23)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:80:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:83:25)

  ‚óè KieVideoClient ‚Ä∫ generateAnimatedVideo ‚Ä∫ should timeout if max attempts reached

    expect(received).rejects.toThrow(expected)

    Expected pattern: /timed out/
    Received message: "Kie.ai API error undefined: Unknown error"

          86 |                 const errorDesc = data.msg || data.message || 'Unknown error';
          87 |                 console.error(`[Kie.ai] API Error (${data.code}): ${errorDesc}`);
        > 88 |                 throw new Error(`Kie.ai API error ${data.code}: ${errorDesc}`);
             |                       ^
          89 |             }
          90 |
          91 |             const jobId = data.data?.taskId || data.taskId || data.id;

      at KieVideoClient.createTask (src/infrastructure/video/KieVideoClient.ts:88:23)
      at KieVideoClient.generateAnimatedVideo (src/infrastructure/video/KieVideoClient.ts:39:23)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:90:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/infrastructure/KieVideoClient.test.ts:93:25)

FAIL tests/unit/SegmentConsistency.test.ts
  ‚óè ReelOrchestrator Segment Consistency ‚Ä∫ Should FAIL if LLM returns fewer segments than planned

    expect(received).rejects.toThrow(expected)

    Expected pattern: /Segment count mismatch/
    Received message: "this.deps.llmClient.detectReelMode is not a function"

          139 |             if (job.isAnimatedVideoMode === undefined) {
          140 |                 await this.updateJobStatus(jobId, 'detecting_intent', 'Analyzing request for animation...');
        > 141 |                 detectionResult = await this.deps.llmClient.detectReelMode(transcript);
              |                                                             ^
          142 |                 console.log(`[${jobId}] Reel Mode: ${detectionResult.isAnimatedMode ? 'ANIMATED VIDEO' : 'IMAGES'}`);
          143 |
          144 |                 await this.deps.jobManager.updateJob(jobId, {

      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:141:61)
      at Object.<anonymous> (tests/unit/SegmentConsistency.test.ts:70:9)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/unit/SegmentConsistency.test.ts:70:62)

FAIL tests/e2e/reel-generation.test.ts
  ‚óè ReelOrchestrator E2E ‚Ä∫ should generate reel end-to-end successfully

    OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "2705",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are the creative mind behind \\\"Challenging View,\\\" an Instagram channel that uses spiritual psychology and caustic ancient wisdom to expose modern self-deception.\\n\\nVOICE AND PERSONALITY:\\n- Tone: Direct, grounded, spiritually perspicacious, unapologetic.\\n- Background: A mix of Indian cultural roots and Californian psychological directness.\\n- Philosophy: Truth is often uncomfortable; your job is to deliver it with surgical precision.\\n- Style: Pattern-breaking. You stop the scroll by saying what others are too polite or too deluded to say.\\n\\nWRITING GUIDELINES:\\n1. NO FLUFF: Avoid introductory filler (\\\"In this video,\\\" \\\"So,\\\" \\\"Hey guys\\\"). Start with the punch.\\n2. CONSTRUCTIVE CAUSTICITY: Be sharp, but the goal is always deeper self-awareness, not just being mean.\\n3. GROUNDED SPIRITUALITY: Use terms like \\\"shadow work,\\\" \\\"projection,\\\" \\\"bypass,\\\" and \\\"ego mechanics.\\\" Avoid \\\"love and light\\\" or generic wellness clich√©s.\\n4. MICRO-DOSE INSIGHT: Every sentence must earned its place. If it doesn't challenge or reveal, cut it.\\n5. CULTURAL FUSION: Subtly weave in Vedantic or Zen concepts without being \\\"yoga-teacher-y.\\\"\\n\\nIMAGE STYLE:\\n- Aesthetic: Muted, cinematic, grounded, slightly dark but clear.\\n- Preference for high-contrast, moody lighting.\\n- Focus on symbolic objects or minimalist environments that mirror the psychological state.\"},{\"role\":\"user\",\"content\":\"Generate visual prompts for an Instagram Reel based on the provided commentary.\\n\\nCONCEPT SUMMARY: \\\"A mindful exploration of presence and meditation\\\"\\nOVERALL MOOD: \\\"peaceful and contemplative\\\"\\nSEGMENT COUNT: 3\\n\\nINPUT COMMENTARIES:\\nSegment 1: \\\"Segment 1 content.\\\"\\nSegment 2: \\\"Segment 2 content.\\\"\\nSegment 3: \\\"Segment 3 content.\\\"\\n\\nTASK:\\nFor each commentary segment, generate:\\n1. imagePrompt: Detailed Midjourney-style prompt illustrating the commentary.\\n2. caption: Short 3-5 word text overlay.\\n3. continuityTags: Object with visual consistency trackers.\\n\\nSCENE CONTINUITY RULES:\\n- Index 0: Establish anchor (location, lighting, style).\\n- Index 1+: \\\"Continuation of previous scene:\\\" + reference previous tags.\\n- IMAGE POLICY: If people/couples are depicted, they MUST be a Heterosexual couple (to maintain brand consistency).\\n\\nRespond as JSON array (SAME ORDER as input):\\n[\\n  {\\n    \\\"imagePrompt\\\": \\\"...\\\",\\n    \\\"caption\\\": \\\"...\\\",\\n    \\\"continuityTags\\\": {\\n      \\\"location\\\": \\\"...\\\",\\n      \\\"timeOfDay\\\": \\\"...\\\",\\n      \\\"dominantColor\\\": \\\"...\\\",\\n      \\\"heroProp\\\": \\\"...\\\",\\n      \\\"wardrobeDetail\\\": \\\"...\\\"\\n    }\\n  },\\n  ...\\n]\"}],\"temperature\":0.7,\"response_format\":{\"type\":\"json_object\"}}"
    }

      94 |         }
      95 |
    > 96 |         throw new Error(`OpenAI call failed: ${message}`);
         |               ^
      97 |     }
      98 |
      99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.generateVisuals (src/infrastructure/llm/StandardReelGenerator.ts:211:26)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:80:25)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:108:24)

  ‚óè ReelOrchestrator E2E ‚Ä∫ should fall back to DALL-E when OpenRouter fails with text response

    OpenAI call failed: Nock: No match for request {
      "method": "POST",
      "url": "https://api.openai.com/v1/chat/completions",
      "headers": {
        "accept": "application/json, text/plain, */*",
        "accept-encoding": "gzip, compress, deflate, br",
        "authorization": "Bearer test-key",
        "connection": "close",
        "content-length": "2670",
        "content-type": "application/json",
        "user-agent": "axios/1.13.2"
      },
      "body": "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"system\",\"content\":\"You are the creative mind behind \\\"Challenging View,\\\" an Instagram channel that uses spiritual psychology and caustic ancient wisdom to expose modern self-deception.\\n\\nVOICE AND PERSONALITY:\\n- Tone: Direct, grounded, spiritually perspicacious, unapologetic.\\n- Background: A mix of Indian cultural roots and Californian psychological directness.\\n- Philosophy: Truth is often uncomfortable; your job is to deliver it with surgical precision.\\n- Style: Pattern-breaking. You stop the scroll by saying what others are too polite or too deluded to say.\\n\\nWRITING GUIDELINES:\\n1. NO FLUFF: Avoid introductory filler (\\\"In this video,\\\" \\\"So,\\\" \\\"Hey guys\\\"). Start with the punch.\\n2. CONSTRUCTIVE CAUSTICITY: Be sharp, but the goal is always deeper self-awareness, not just being mean.\\n3. GROUNDED SPIRITUALITY: Use terms like \\\"shadow work,\\\" \\\"projection,\\\" \\\"bypass,\\\" and \\\"ego mechanics.\\\" Avoid \\\"love and light\\\" or generic wellness clich√©s.\\n4. MICRO-DOSE INSIGHT: Every sentence must earned its place. If it doesn't challenge or reveal, cut it.\\n5. CULTURAL FUSION: Subtly weave in Vedantic or Zen concepts without being \\\"yoga-teacher-y.\\\"\\n\\nIMAGE STYLE:\\n- Aesthetic: Muted, cinematic, grounded, slightly dark but clear.\\n- Preference for high-contrast, moody lighting.\\n- Focus on symbolic objects or minimalist environments that mirror the psychological state.\"},{\"role\":\"user\",\"content\":\"Generate visual prompts for an Instagram Reel based on the provided commentary.\\n\\nCONCEPT SUMMARY: \\\"A mindful exploration of presence and meditation\\\"\\nOVERALL MOOD: \\\"peaceful and contemplative\\\"\\nSEGMENT COUNT: 2\\n\\nINPUT COMMENTARIES:\\nSegment 1: \\\"Segment 1 content.\\\"\\nSegment 2: \\\"Segment 2 content.\\\"\\n\\nTASK:\\nFor each commentary segment, generate:\\n1. imagePrompt: Detailed Midjourney-style prompt illustrating the commentary.\\n2. caption: Short 3-5 word text overlay.\\n3. continuityTags: Object with visual consistency trackers.\\n\\nSCENE CONTINUITY RULES:\\n- Index 0: Establish anchor (location, lighting, style).\\n- Index 1+: \\\"Continuation of previous scene:\\\" + reference previous tags.\\n- IMAGE POLICY: If people/couples are depicted, they MUST be a Heterosexual couple (to maintain brand consistency).\\n\\nRespond as JSON array (SAME ORDER as input):\\n[\\n  {\\n    \\\"imagePrompt\\\": \\\"...\\\",\\n    \\\"caption\\\": \\\"...\\\",\\n    \\\"continuityTags\\\": {\\n      \\\"location\\\": \\\"...\\\",\\n      \\\"timeOfDay\\\": \\\"...\\\",\\n      \\\"dominantColor\\\": \\\"...\\\",\\n      \\\"heroProp\\\": \\\"...\\\",\\n      \\\"wardrobeDetail\\\": \\\"...\\\"\\n    }\\n  },\\n  ...\\n]\"}],\"temperature\":0.7,\"response_format\":{\"type\":\"json_object\"}}"
    }

      94 |         }
      95 |
    > 96 |         throw new Error(`OpenAI call failed: ${message}`);
         |               ^
      97 |     }
      98 |
      99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.generateVisuals (src/infrastructure/llm/StandardReelGenerator.ts:211:26)
      at StandardReelGenerator.generateSegmentContent (src/infrastructure/llm/StandardReelGenerator.ts:80:25)
      at ReelOrchestrator.processJob (src/application/ReelOrchestrator.ts:328:38)
      at Object.<anonymous> (tests/e2e/reel-generation.test.ts:134:24)

FAIL tests/integration/ParableCaptionLive.test.ts
  ‚óè Test suite failed to run

    Your test suite must contain at least one test.

      at onResult (node_modules/@jest/core/build/index.js:1057:18)
      at node_modules/@jest/core/build/index.js:1127:165
      at node_modules/emittery/index.js:363:13
          at Array.map (<anonymous>)
      at Emittery.emit (node_modules/emittery/index.js:361:23)

FAIL tests/chaos/chaos.test.ts
  ‚óè Chaos Tests - API Failure Scenarios ‚Ä∫ Rate Limit Handling ‚Ä∫ should throw on 429 from OpenAI

    expect(received).rejects.toThrow(expected)

    Expected substring: "LLM call failed"
    Received message:   "OpenAI call failed: Nock: No match for request {
      \"method\": \"POST\",
      \"url\": \"https://api.openai.com/v1/chat/completions\",
      \"headers\": {
        \"accept\": \"application/json, text/plain, */*\",
        \"accept-encoding\": \"gzip, compress, deflate, br\",
        \"authorization\": \"Bearer test-key\",
        \"connection\": \"close\",
        \"content-length\": \"2142\",
        \"content-type\": \"application/json\",
        \"user-agent\": \"axios/1.13.2\"
      },
      \"body\": \"{\\\"model\\\":\\\"gpt-4o\\\",\\\"messages\\\":[{\\\"role\\\":\\\"system\\\",\\\"content\\\":\\\"You are the creative mind behind \\\\\\\"Challenging View,\\\\\\\" an Instagram channel that uses spiritual psychology and caustic ancient wisdom to expose modern self-deception.\\\\n\\\\nVOICE AND PERSONALITY:\\\\n- Tone: Direct, grounded, spiritually perspicacious, unapologetic.\\\\n- Background: A mix of Indian cultural roots and Californian psychological directness.\\\\n- Philosophy: Truth is often uncomfortable; your job is to deliver it with surgical precision.\\\\n- Style: Pattern-breaking. You stop the scroll by saying what others are too polite or too deluded to say.\\\\n\\\\nWRITING GUIDELINES:\\\\n1. NO FLUFF: Avoid introductory filler (\\\\\\\"In this video,\\\\\\\" \\\\\\\"So,\\\\\\\" \\\\\\\"Hey guys\\\\\\\"). Start with the punch.\\\\n2. CONSTRUCTIVE CAUSTICITY: Be sharp, but the goal is always deeper self-awareness, not just being mean.\\\\n3. GROUNDED SPIRITUALITY: Use terms like \\\\\\\"shadow work,\\\\\\\" \\\\\\\"projection,\\\\\\\" \\\\\\\"bypass,\\\\\\\" and \\\\\\\"ego mechanics.\\\\\\\" Avoid \\\\\\\"love and light\\\\\\\" or generic wellness clich√©s.\\\\n4. MICRO-DOSE INSIGHT: Every sentence must earned its place. If it doesn't challenge or reveal, cut it.\\\\n5. CULTURAL FUSION: Subtly weave in Vedantic or Zen concepts without being \\\\\\\"yoga-teacher-y.\\\\\\\"\\\\n\\\\nIMAGE STYLE:\\\\n- Aesthetic: Muted, cinematic, grounded, slightly dark but clear.\\\\n- Preference for high-contrast, moody lighting.\\\\n- Focus on symbolic objects or minimalist environments that mirror the psychological state.\\\"},{\\\"role\\\":\\\"user\\\",\\\"content\\\":\\\"Plan an Instagram Reel structure based on this transcript.\\\\n\\\\nTranscript: \\\\\\\"test\\\\\\\"\\\\nConstraints: 10s to 15s\\\\n\\\\nTASK:\\\\n1. Extract the core psychological insight.\\\\n2. Determine the optimal total duration (within constraints).\\\\n3. Calculate the number of segments (aim for 5-8s per segment).\\\\n4. Determine the overall mood (e.g., \\\\\\\"Dark/Grounded\\\\\\\", \\\\\\\"Cinematic/Epic\\\\\\\", \\\\\\\"Minimalist/Meditative\\\\\\\").\\\\n\\\\nRespond with a JSON object:\\\\n{\\\\n  \\\\\\\"summary\\\\\\\": \\\\\\\"One sentence summary of the core insight\\\\\\\",\\\\n  \\\\\\\"mood\\\\\\\": \\\\\\\"overall visual mood\\\\\\\",\\\\n  \\\\\\\"targetDurationSeconds\\\\\\\": total_seconds,\\\\n  \\\\\\\"segmentCount\\\\\\\": number_of_segments\\\\n}\\\"}],\\\"temperature\\\":0.7,\\\"response_format\\\":{\\\"type\\\":\\\"json_object\\\"}}\"
    }"

          94 |         }
          95 |
        > 96 |         throw new Error(`OpenAI call failed: ${message}`);
             |               ^
          97 |     }
          98 |
          99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:36:26)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:104:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:105:26)

  ‚óè Chaos Tests - API Failure Scenarios ‚Ä∫ Invalid Credentials ‚Ä∫ should throw clear error on 401 Unauthorized

    expect(received).rejects.toThrow(expected)

    Expected substring: "LLM call failed: Invalid API key"
    Received message:   "OpenAI call failed: Invalid API key"

          94 |         }
          95 |
        > 96 |         throw new Error(`OpenAI call failed: ${message}`);
             |               ^
          97 |     }
          98 |
          99 |     private shouldRetry(status: number | undefined, attempt: number, maxRetries: number): boolean {

      at OpenAIService.handleError (src/infrastructure/llm/OpenAIService.ts:96:15)
      at OpenAIService.chatCompletion (src/infrastructure/llm/OpenAIService.ts:39:32)
      at StandardReelGenerator.planReel (src/infrastructure/llm/StandardReelGenerator.ts:36:26)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:118:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (tests/chaos/chaos.test.ts:119:26)

FAIL tests/unit/infrastructure/OpenAIImageClient.test.ts (6.871 s)
  ‚óè OpenAIImageClient ‚Ä∫ generateImage() - Error handling ‚Ä∫ should handle 429 rate limit after retries

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      112 |         });
      113 |
    > 114 |         it('should handle 429 rate limit after retries', async () => {
          |         ^
      115 |             const client = new OpenAIImageClient(apiKey, baseUrl);
      116 |
      117 |             // Mock 3 consecutive 429 errors (maxRetries = 3)

      at tests/unit/infrastructure/OpenAIImageClient.test.ts:114:9
      at tests/unit/infrastructure/OpenAIImageClient.test.ts:97:5
      at Object.<anonymous> (tests/unit/infrastructure/OpenAIImageClient.test.ts:4:1)

FAIL tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts (5.073 s)
  ‚óè OpenAILLMClient.detectReelMode ‚Ä∫ Error handling ‚Ä∫ should handle API errors gracefully and default to image mode

    thrown: "Exceeded timeout of 5000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      122 |
      123 |     describe('Error handling', () => {
    > 124 |         it('should handle API errors gracefully and default to image mode', async () => {
          |         ^
      125 |             nock('https://api.openai.com')
      126 |                 .post('/v1/chat/completions')
      127 |                 .replyWithError('Network error');

      at tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:124:9
      at tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:123:5
      at Object.<anonymous> (tests/unit/infrastructure/OpenAILLMClient.detectReelMode.test.ts:5:1)

  ‚óè OpenAILLMClient.detectReelMode ‚Ä∫ Error handling ‚Ä∫ should handle API errors gracefully and default to image mode




  ‚óè OpenAILLMClient.detectReelMode ‚Ä∫ Error handling ‚Ä∫ should handle API errors gracefully and default to image mode





Test Suites: 13 failed, 1 skipped, 47 passed, 60 of 61 total
Tests:       22 failed, 3 skipped, 562 passed, 587 total
Snapshots:   0 total
Time:        14.805 s, estimated 15 s
Ran all test suites.
